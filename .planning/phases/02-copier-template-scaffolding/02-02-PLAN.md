---
phase: 02-copier-template-scaffolding
plan: 02
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - "template/custom_components/[[ project_domain ]]/[% if use_websocket %]websocket[% endif %].py.jinja"
  - "template/custom_components/[[ project_domain ]]/[% if use_services %]services[% endif %].py.jinja"
  - "template/custom_components/[[ project_domain ]]/[% if use_secondary_coordinator %]coordinator_secondary[% endif %].py.jinja"
autonomous: true
requirements:
  - COPR-05
  - COPR-06
  - COPR-07

must_haves:
  truths:
    - "copier copy generates a project with the correct domain in all file paths and file contents"
    - "Generated Python files contain valid Python syntax (no corrupted braces from Jinja2)"
    - "Conditional files (websocket.py, services.py, coordinator_secondary.py) appear when their flag is true and are absent when false"
    - "Generated manifest.json contains all hassfest-required fields with correct values from copier questions"
    - "copier update in a child project applies template changes via 3-way merge"
    - ".copier-answers.yml exists in generated project with DO NOT EDIT warning"
  artifacts:
    - path: "template/custom_components/[[ project_domain ]]/[% if use_websocket %]websocket[% endif %].py.jinja"
      provides: "Conditional WebSocket module placeholder"
      contains: "[[ project_name ]]"
    - path: "template/custom_components/[[ project_domain ]]/[% if use_services %]services[% endif %].py.jinja"
      provides: "Conditional services module placeholder"
      contains: "[[ project_name ]]"
    - path: "template/custom_components/[[ project_domain ]]/[% if use_secondary_coordinator %]coordinator_secondary[% endif %].py.jinja"
      provides: "Conditional secondary coordinator placeholder"
      contains: "[[ project_name ]]"
  key_links:
    - from: "copier.yml use_websocket question"
      to: "[% if use_websocket %]websocket[% endif %].py.jinja"
      via: "Copier conditional filename — empty name when false causes file to be skipped"
      pattern: "use_websocket"
    - from: "copier copy output"
      to: "manifest.json"
      via: "All hassfest fields populated from copier question answers"
      pattern: "domain.*name.*codeowners.*iot_class"
    - from: ".copier-answers.yml in child"
      to: "copier update 3-way merge"
      via: "_commit tag anchors the version; copier regenerates and diffs"
      pattern: "_commit"
---

<objective>
Add conditional file templates for optional modules, then smoke-test the complete Copier pipeline: `copier copy` generates a valid project, conditional files include/exclude correctly, generated output passes hassfest field requirements, and `copier update` works via 3-way merge.

Purpose: Validates that the template pipeline from 02-01 actually works end-to-end. Without this verification, all subsequent phases would build on an untested foundation. Also establishes the conditional file pattern needed for Phase 5's WebSocket, services, multi-coordinator, and multi-step config modules.

Output: Three conditional file templates (placeholders for Phase 5 content), verified copier copy/update pipeline, git tag for copier update support.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-copier-template-scaffolding/02-RESEARCH.md
@.planning/phases/02-copier-template-scaffolding/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conditional file templates for optional modules</name>
  <files>
template/custom_components/[[ project_domain ]]/[% if use_websocket %]websocket[% endif %].py.jinja
template/custom_components/[[ project_domain ]]/[% if use_services %]services[% endif %].py.jinja
template/custom_components/[[ project_domain ]]/[% if use_secondary_coordinator %]coordinator_secondary[% endif %].py.jinja
  </files>
  <action>
Create three conditional file templates in `template/custom_components/[[ project_domain ]]/`. These are **placeholder stubs** — Phase 5 will fill in the real implementation. The filenames use `[% if condition %]name[% endif %].py.jinja` pattern so Copier skips them when the condition is false.

**CRITICAL filename pattern:** The `.py.jinja` suffix MUST be OUTSIDE the `[% if %]...[% endif %]` block. When the condition is false, the filename renders to `.py.jinja` (empty base name), and Copier skips it.

1. **`[% if use_websocket %]websocket[% endif %].py.jinja`**:
```python
"""WebSocket API for the [[ project_name ]] integration."""

from __future__ import annotations

# TODO: Implement WebSocket command handlers (Phase 5)
# See: homeassistant.components.websocket_api
```

2. **`[% if use_services %]services[% endif %].py.jinja`**:
```python
"""Service handlers for the [[ project_name ]] integration."""

from __future__ import annotations

# TODO: Implement service call handlers (Phase 5)
# See: homeassistant.core.ServiceCall, SupportsResponse
```

3. **`[% if use_secondary_coordinator %]coordinator_secondary[% endif %].py.jinja`**:
```python
"""Secondary DataUpdateCoordinator for the [[ project_name ]] integration."""

from __future__ import annotations

# TODO: Implement secondary coordinator with independent poll interval (Phase 5)
# See: homeassistant.helpers.update_coordinator.DataUpdateCoordinator
```

Each file is minimal (docstring + TODO comment). The real content comes in Phase 5. The purpose here is to prove the conditional filename mechanism works.
  </action>
  <verify>
Verify the files exist with the exact conditional naming:
```bash
ls template/custom_components/\[\[\ project_domain\ \]\]/\[%\ if\ use_websocket\ %\]websocket\[%\ endif\ %\].py.jinja
ls template/custom_components/\[\[\ project_domain\ \]\]/\[%\ if\ use_services\ %\]services\[%\ endif\ %\].py.jinja
ls template/custom_components/\[\[\ project_domain\ \]\]/\[%\ if\ use_secondary_coordinator\ %\]coordinator_secondary\[%\ endif\ %\].py.jinja
```
  </verify>
  <done>Three conditional file templates exist with correct [% if %] filename patterns. Each contains a placeholder docstring with [[ project_name ]] substitution and a TODO referencing Phase 5.</done>
</task>

<task type="auto">
  <name>Task 2: Smoke-test copier copy, conditional files, hassfest fields, and copier update</name>
  <files></files>
  <action>
This task runs verification commands — it does NOT modify template files. It validates the entire pipeline.

**Step 1: Tag the template repo for copier update support.**
```bash
git tag 0.1.0
```
Copier requires a git tag to anchor `_commit` in `.copier-answers.yml`. Without it, `copier update` cannot determine the base version.

**Step 2: Run copier copy with default answers (no conditionals).**
```bash
copier copy --defaults \
  --data project_domain=test_integration \
  --data project_name="Test Integration" \
  --data project_description="A test integration" \
  --data author_name=testuser \
  --data iot_class=local_polling \
  --data integration_type=service \
  --data version=0.1.0 \
  --data documentation_url="https://github.com/testuser/ha-test-integration" \
  --data issue_tracker_url="https://github.com/testuser/ha-test-integration/issues" \
  /home/dab/Projects/ha-hacs-template /tmp/test-copier-output
```

**Step 3: Verify generated project structure.**
Check that:
- `custom_components/test_integration/` directory exists (domain substituted in path)
- `custom_components/test_integration/const.py` contains `DOMAIN = "test_integration"`
- `custom_components/test_integration/__init__.py` contains `class TestIntegrationData:` (PascalCase)
- `custom_components/test_integration/manifest.json` has all 7+ hassfest-required fields: domain, name, codeowners, dependencies, documentation, integration_type, iot_class, requirements, version
- `custom_components/test_integration/manifest.json` has `"domain": "test_integration"` and `"name": "Test Integration"`
- `.copier-answers.yml` exists with "NEVER EDIT MANUALLY" warning
- `hacs.json` exists with `"name": "Test Integration"`
- `custom_components/test_integration/frontend/test_integration-card.js` exists and contains `class TestIntegrationCard`
- Python files parse without syntax errors: `python3 -m py_compile custom_components/test_integration/const.py` etc.
- Conditional files (websocket.py, services.py, coordinator_secondary.py) do NOT exist (defaults are false)

**Step 4: Verify conditional file inclusion.**
```bash
copier copy --defaults \
  --data project_domain=test_ws \
  --data project_name="Test WS" \
  --data author_name=testuser \
  --data use_websocket=true \
  --data use_services=true \
  --data use_secondary_coordinator=true \
  /home/dab/Projects/ha-hacs-template /tmp/test-copier-conditionals
```
Check that:
- `custom_components/test_ws/websocket.py` exists
- `custom_components/test_ws/services.py` exists
- `custom_components/test_ws/coordinator_secondary.py` exists

**Step 5: Verify copier update works.**
```bash
cd /tmp/test-copier-output
git init && git add -A && git commit -m "initial"
copier update --defaults
```
Should complete without errors. The `.copier-answers.yml` should still exist with `_commit: 0.1.0`.

**Step 6: Clean up.**
```bash
rm -rf /tmp/test-copier-output /tmp/test-copier-conditionals
```

**If copier is not installed:** Install with `uv tool install copier` or `pipx install copier` first.

**If any check fails:** Fix the template files (copier.yml or .jinja files) and re-run. Document what was fixed in the SUMMARY. Common issues:
- Wrong delimiter in filename → Copier error or file not skipped
- Missing question → Copier prompts interactively (should not happen with --defaults + --data)
- Python syntax error in generated file → Jinja2 ate a brace somewhere (check _envops)
- hassfest field missing → Add to manifest.json.jinja
  </action>
  <verify>
All Step 3, 4, and 5 checks pass. Specifically:
1. `test -d /tmp/test-copier-output/custom_components/test_integration` — domain in path
2. `grep '"test_integration"' /tmp/test-copier-output/custom_components/test_integration/manifest.json` — domain in manifest
3. `python3 -m py_compile /tmp/test-copier-output/custom_components/test_integration/const.py` — valid Python
4. `test ! -f /tmp/test-copier-output/custom_components/test_integration/websocket.py` — conditional excluded
5. `test -f /tmp/test-copier-conditionals/custom_components/test_ws/websocket.py` — conditional included
6. `grep "NEVER EDIT" /tmp/test-copier-output/.copier-answers.yml` — answers file warning
  </verify>
  <done>
copier copy generates a valid project with correct domain substitution in paths and content. Generated Python files compile without errors. Conditional files appear when enabled and are absent when disabled. manifest.json has all hassfest-required fields. .copier-answers.yml is generated with DO NOT EDIT warning. copier update completes without errors against a tagged template version.
  </done>
</task>

</tasks>

<verification>
1. Conditional file templates exist with [% if %] filename pattern
2. copier copy --defaults produces a project with correct domain in all paths and content
3. Generated Python files pass py_compile (no Jinja2/Python brace corruption)
4. Generated manifest.json has all hassfest-required fields
5. Conditional files (websocket, services, coordinator_secondary) included when flags=true, excluded when flags=false
6. .copier-answers.yml generated with warning comment and _commit version
7. copier update completes without errors on a child project
</verification>

<success_criteria>
- copier copy produces a valid HA integration directory structure with domain substitution throughout
- All generated Python files pass py_compile (syntax check)
- Conditional files correctly include/exclude based on boolean flags
- Generated manifest.json contains domain, name, codeowners, dependencies, documentation, integration_type, iot_class, requirements, version
- copier update works against a tagged template version
- .copier-answers.yml exists in generated output with DO NOT EDIT warning
</success_criteria>

<output>
After completion, create `.planning/phases/02-copier-template-scaffolding/02-02-SUMMARY.md`
</output>
