---
phase: 02-copier-template-scaffolding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - copier.yml
  - template/{{ _copier_conf.answers_file }}.jinja
  - template/hacs.json.jinja
  - template/README.md.jinja
  - template/.gitignore
  - template/custom_components/[[ project_domain ]]/__init__.py.jinja
  - template/custom_components/[[ project_domain ]]/config_flow.py.jinja
  - template/custom_components/[[ project_domain ]]/const.py.jinja
  - template/custom_components/[[ project_domain ]]/coordinator.py.jinja
  - template/custom_components/[[ project_domain ]]/sensor.py.jinja
  - template/custom_components/[[ project_domain ]]/manifest.json.jinja
  - template/custom_components/[[ project_domain ]]/strings.json.jinja
  - template/custom_components/[[ project_domain ]]/translations/en.json.jinja
  - template/custom_components/[[ project_domain ]]/frontend/[[ project_domain ]]-card.js.jinja
autonomous: true
requirements:
  - COPR-01
  - COPR-02
  - COPR-03
  - COPR-04
  - COPR-08

must_haves:
  truths:
    - "copier.yml exists at repo root with _envops custom delimiters ([[ ]] / [% %]) and all required questions"
    - "All existing source files are converted to .jinja templates inside template/ subdirectory with [[ ]] variable substitutions replacing hardcoded hacs_template references"
    - "Domain directory uses Copier Jinja2 naming: custom_components/[[ project_domain ]]/"
    - "Python template files contain zero {% raw %} blocks — brace collision is eliminated entirely by _envops"
    - ".copier-answers.yml template exists and will generate the answers file with DO NOT EDIT warning"
  artifacts:
    - path: "copier.yml"
      provides: "Copier configuration with _envops, _subdirectory, and all project questions"
      contains: "_envops"
    - path: "template/{{ _copier_conf.answers_file }}.jinja"
      provides: "Answers file template for copier update support"
      contains: "_copier_answers"
    - path: "template/custom_components/[[ project_domain ]]/const.py.jinja"
      provides: "Constants with Copier variable substitution"
      contains: "[[ project_domain ]]"
    - path: "template/custom_components/[[ project_domain ]]/manifest.json.jinja"
      provides: "HA manifest with all hassfest-required fields from Copier questions"
      contains: "[[ project_domain ]]"
  key_links:
    - from: "copier.yml"
      to: "template/"
      via: "_subdirectory: template"
      pattern: "_subdirectory: template"
    - from: "copier.yml _envops"
      to: "all .jinja files"
      via: "Custom delimiters [[ ]] and [% %] used in file content and filenames"
      pattern: "variable_start_string.*\\[\\["
    - from: "copier.yml questions"
      to: "template/custom_components/[[ project_domain ]]/manifest.json.jinja"
      via: "project_domain, project_name, author_name, iot_class, etc. substituted into manifest fields"
      pattern: "\\[\\[ project_domain \\]\\]"
---

<objective>
Create the Copier template pipeline: copier.yml with _envops custom delimiters and all project questions, restructure existing integration files into a template/ subdirectory with .jinja suffixes and [[ ]] variable substitutions, and set up the .copier-answers.yml template.

Purpose: This is the foundation for all subsequent phases. Once this plan completes, the repo IS a working Copier template — `copier copy` can render a project (tested in plan 02-02). Every Python file written in Phases 3-7 will be a .jinja template in this directory structure.

Output: copier.yml at repo root, template/ subdirectory containing all .jinja files with Copier variable substitutions, answers file template.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-copier-template-scaffolding/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create copier.yml with _envops and project questions</name>
  <files>copier.yml</files>
  <action>
Create `copier.yml` at the repo root with the following content:

**Copier settings:**
- `_subdirectory: template` — template content lives in `template/`, keeping copier.yml and repo docs at root
- `_templates_suffix: .jinja` — only files with .jinja suffix are rendered
- `_envops:` block with custom delimiters:
  - `autoescape: false`
  - `block_start_string: "[%"` / `block_end_string: "%]"`
  - `variable_start_string: "[["` / `variable_end_string: "]]"`
  - `comment_start_string: "[#"` / `comment_end_string: "#]"`
  - `keep_trailing_newline: true`

**Questions (in this order):**
1. `project_domain` — type: str, help: "Integration domain (lowercase, underscores, e.g. my_integration)", validator: must match `^[a-z][a-z0-9_]*$` using `[% if not (project_domain | regex_search(...)) %]` syntax
2. `project_name` — type: str, help: "Human-readable name", default: `[[ project_domain | replace('_', ' ') | title ]]`
3. `project_description` — type: str, help: "Short description", default: "A Home Assistant integration."
4. `author_name` — type: str, help: "GitHub username (for manifest codeowners)"
5. `iot_class` — type: str, default: local_polling, choices: [assumed_state, cloud_polling, cloud_push, local_polling, local_push, calculated]
6. `integration_type` — type: str, default: service, choices: [hub, device, entity, helper, service, hardware, system, virtual]
7. `use_websocket` — type: bool, default: false, help: "Include WebSocket API?"
8. `use_services` — type: bool, default: false, help: "Include custom services (actions)?"
9. `use_secondary_coordinator` — type: bool, default: false, help: "Include a secondary DataUpdateCoordinator?"
10. `use_multi_step_config_flow` — type: bool, default: false, help: "Include multi-step config flow?"
11. `version` — type: str, default: "0.1.0", help: "Initial version (SemVer)"
12. `documentation_url` — type: str, default: `https://github.com/[[ author_name ]]/ha-[[ project_domain | replace('_', '-') ]]`
13. `issue_tracker_url` — type: str, default: `https://github.com/[[ author_name ]]/ha-[[ project_domain | replace('_', '-') ]]/issues`

Do NOT include `_exclude` (the defaults are correct with `_subdirectory`). Do NOT include `_tasks`.
  </action>
  <verify>
Verify the file exists, YAML parses correctly, and contains `_envops`, `_subdirectory: template`, and all 13 question keys:
```bash
python3 -c "import yaml; d=yaml.safe_load(open('copier.yml')); assert '_envops' in d; assert d['_subdirectory']=='template'; assert 'project_domain' in d"
```
  </verify>
  <done>copier.yml exists at repo root with _envops custom delimiters, _subdirectory: template, and all 13 questions with correct types, defaults, choices, and validators.</done>
</task>

<task type="auto">
  <name>Task 2: Restructure existing files into template/ with .jinja variable substitutions</name>
  <files>
template/{{ _copier_conf.answers_file }}.jinja
template/hacs.json.jinja
template/README.md.jinja
template/.gitignore
template/custom_components/[[ project_domain ]]/__init__.py.jinja
template/custom_components/[[ project_domain ]]/config_flow.py.jinja
template/custom_components/[[ project_domain ]]/const.py.jinja
template/custom_components/[[ project_domain ]]/coordinator.py.jinja
template/custom_components/[[ project_domain ]]/sensor.py.jinja
template/custom_components/[[ project_domain ]]/manifest.json.jinja
template/custom_components/[[ project_domain ]]/strings.json.jinja
template/custom_components/[[ project_domain ]]/translations/en.json.jinja
template/custom_components/[[ project_domain ]]/frontend/[[ project_domain ]]-card.js.jinja
  </files>
  <action>
Create the `template/` directory structure. For each file, convert hardcoded `hacs_template` / `HACS Template` references to Copier `[[ ]]` variable substitutions. The directory `custom_components/hacs_template/` becomes `custom_components/[[ project_domain ]]/`.

**Important:** After creating the template/ directory, REMOVE the original `custom_components/` directory and `hacs.json` from the repo root — they are now inside `template/`. The repo root should only have `copier.yml`, `README.md`, `LICENSE`, `.github/`, `.gitignore`, `.planning/`, `.claude/`, and `template/`.

The repo-root `README.md` should be updated to describe this as a Copier template (not a GitHub "Use this template" project). The repo-root `.gitignore` stays at root (not inside template/).

**File-by-file conversion rules:**

All files use `[[ variable ]]` for substitutions (NOT `{{ }}`). Python braces (`dict[str, Any]`, `f"..."`, `{"key": "val"}`) are left as-is — they are safe because Copier only processes `[[ ]]` with `_envops`.

**Derived variables used in templates:**
- `[[ project_domain ]]` — the domain string (e.g., `my_integration`)
- `[[ project_name ]]` — human name (e.g., `My Integration`)
- `[[ project_domain | replace('_', ' ') | title | replace(' ', '') ]]` — PascalCase for Python class names (e.g., `MyIntegration`)
- `[[ project_domain | upper ]]` — uppercase for JS console log prefix
- `[[ project_domain | replace('_', '-') ]]` — kebab-case for card element names

**Substitution map for each file:**

1. **`template/{{ _copier_conf.answers_file }}.jinja`** — The answers file template (filename uses standard `{{ }}` for Copier internal variable). Content:
   ```
   # Changes here will be overwritten by Copier; NEVER EDIT MANUALLY
   [[ _copier_answers|to_nice_yaml -]]
   ```
   NOTE: The content uses `[[ ]]` because `_envops` applies to file content rendering. The filename path `{{ _copier_conf.answers_file }}` is resolved by Copier before content rendering, so it uses standard syntax.

2. **`template/hacs.json.jinja`** — Replace name with `[[ project_name ]]`. Keep `homeassistant: "2025.7.0"` and `render_readme: true`.

3. **`template/README.md.jinja`** — A generated project README. Replace all `hacs_template` / `HACS Template` with `[[ project_domain ]]` / `[[ project_name ]]`. Include HACS badge, install instructions, card usage section. This is the README for GENERATED projects, not the template repo README.

4. **`template/.gitignore`** — Copy the existing `.gitignore` content verbatim (no Jinja substitution needed, but place it in template/ so generated projects get it). No `.jinja` suffix since it has no variables to substitute.

5. **`template/custom_components/[[ project_domain ]]/__init__.py.jinja`**:
   - `"""The HACS Template integration."""` → `"""The [[ project_name ]] integration."""`
   - `class HacsTemplateData:` → `class [[ project_domain | replace('_', ' ') | title | replace(' ', '') ]]Data:`
   - `type HacsTemplateConfigEntry =` → `type [[ project_domain | replace('_', ' ') | title | replace(' ', '') ]]ConfigEntry =`
   - Same PascalCase pattern for the class reference inside `ConfigEntry[...]`
   - Docstrings: replace "HACS Template" with `[[ project_name ]]`
   - All Python braces (`list[Platform]`, `dict`, `f"{DOMAIN}"`) remain untouched

6. **`template/custom_components/[[ project_domain ]]/config_flow.py.jinja`**:
   - `"""Config flow for HACS Template integration."""` → `"""Config flow for [[ project_name ]] integration."""`
   - `class TemplateConfigFlow(ConfigFlow, domain=DOMAIN):` — keep `domain=DOMAIN` (it reads from const.py at runtime, no template substitution needed)
   - `"""Handle a config flow for HACS Template."""` → `"""Handle a config flow for [[ project_name ]]."""`
   - `"""Handle options flow for HACS Template."""` → `"""Handle options flow for [[ project_name ]]."""`
   - All Python braces (dict types, vol.Schema, f-strings) remain untouched

7. **`template/custom_components/[[ project_domain ]]/const.py.jinja`**:
   - `"""Constants for the HACS Template integration."""` → `"""Constants for the [[ project_name ]] integration."""`
   - `DOMAIN = "hacs_template"` → `DOMAIN = "[[ project_domain ]]"`
   - `FRONTEND_SCRIPT_URL = f"/{DOMAIN}/{DOMAIN}-card.js"` — leave as-is (Python f-string, resolves at runtime)

8. **`template/custom_components/[[ project_domain ]]/coordinator.py.jinja`**:
   - `"""DataUpdateCoordinator for HACS Template."""` → `"""DataUpdateCoordinator for [[ project_name ]]."""`
   - All Python braces remain untouched

9. **`template/custom_components/[[ project_domain ]]/sensor.py.jinja`**:
   - `"""Sensor platform for HACS Template."""` → `"""Sensor platform for [[ project_name ]]."""`
   - `from . import HacsTemplateConfigEntry` → `from . import [[ project_domain | replace('_', ' ') | title | replace(' ', '') ]]ConfigEntry`
   - `entry: HacsTemplateConfigEntry,` → `entry: [[ project_domain | replace('_', ' ') | title | replace(' ', '') ]]ConfigEntry,`
   - All Python braces remain untouched

10. **`template/custom_components/[[ project_domain ]]/manifest.json.jinja`**:
    - `"domain": "[[ project_domain ]]"`
    - `"name": "[[ project_name ]]"`
    - `"codeowners": ["@[[ author_name ]]"]`
    - `"documentation": "[[ documentation_url ]]"`
    - `"integration_type": "[[ integration_type ]]"`
    - `"iot_class": "[[ iot_class ]]"`
    - `"issue_tracker": "[[ issue_tracker_url ]]"`
    - `"version": "[[ version ]]"`
    - Keep `"config_flow": true`, `"dependencies": ["frontend"]`, `"requirements": []` as literals

11. **`template/custom_components/[[ project_domain ]]/strings.json.jinja`** — Content is pure JSON with no domain-specific strings. Keep as-is (copy verbatim). Still needs `.jinja` suffix in case future phases add substitutions, but no `[[ ]]` needed now.

12. **`template/custom_components/[[ project_domain ]]/translations/en.json.jinja`** — Same content as strings.json. Keep as-is.

13. **`template/custom_components/[[ project_domain ]]/frontend/[[ project_domain ]]-card.js.jinja`**:
    - `HACS Template Card` → `[[ project_name ]] Card`
    - `HACS-TEMPLATE-CARD` (console log) → `[[ project_domain | upper | replace('_', '-') ]]-CARD`
    - `CARD_VERSION = "0.1.0"` → `CARD_VERSION = "[[ version ]]"`
    - `class HacsTemplateCard` → `class [[ project_domain | replace('_', ' ') | title | replace(' ', '') ]]Card`
    - `hacs-template-card-editor` → `[[ project_domain | replace('_', '-') ]]-card-editor`
    - `class HacsTemplateCardEditor` → `class [[ project_domain | replace('_', ' ') | title | replace(' ', '') ]]CardEditor`
    - `customElements.define("hacs-template-card"` → `customElements.define("[[ project_domain | replace('_', '-') ]]-card"`
    - `customElements.define("hacs-template-card-editor"` → `customElements.define("[[ project_domain | replace('_', '-') ]]-card-editor"`
    - `type: "hacs-template-card"` → `type: "[[ project_domain | replace('_', '-') ]]-card"`
    - `name: "HACS Template Card"` → `name: "[[ project_name ]] Card"`
    - `description: "A template card..."` → `description: "[[ project_description ]]"`
    - `header: "HACS Template"` → `header: "[[ project_name ]]"` (in getStubConfig and setConfig default)
    - JS braces (`{ type: Object }`, `{ ...config }`, etc.) remain untouched

**After creating all template files:**
- Remove `custom_components/` directory from repo root (it is now in `template/custom_components/`)
- Remove `hacs.json` from repo root (it is now `template/hacs.json.jinja`)
- Update repo-root `README.md` to describe this as a Copier template (brief: what it is, `copier copy` usage, link to generated README for project docs)
- Keep repo-root `.gitignore` (it applies to the template repo itself)
- Keep `.github/workflows/` at repo root (these are template repo CI, not generated project CI)
  </action>
  <verify>
1. Verify template directory structure exists:
```bash
ls template/custom_components/\[\[\ project_domain\ \]\]/*.py.jinja
```
2. Verify original custom_components/ is removed:
```bash
test ! -d custom_components && echo "PASS: original removed"
```
3. Verify no `{{ }}` standard delimiters in .jinja file content (should only use `[[ ]]`):
```bash
grep -r '{{ ' template/custom_components/ --include='*.jinja' | grep -v '_copier_' | head -5
```
(Should return empty — no standard delimiters in template content files)
4. Verify `[[ project_domain ]]` appears in const.py.jinja:
```bash
grep 'project_domain' template/custom_components/*/const.py.jinja
```
  </verify>
  <done>
All existing integration files are restructured into template/ with .jinja suffixes and [[ ]] variable substitutions. The domain directory uses [[ project_domain ]] naming. Original custom_components/ and hacs.json are removed from repo root. The answers file template exists at template/{{ _copier_conf.answers_file }}.jinja. No Python brace collision exists — all Python dict/f-string/type braces are untouched.
  </done>
</task>

</tasks>

<verification>
1. copier.yml exists at repo root with _envops, _subdirectory, and 13 questions
2. template/ directory contains all .jinja files with correct [[ ]] substitutions
3. No standard {{ }} delimiters in template content files (only in answers file template filename)
4. Domain directory named [[ project_domain ]] (literal — Copier resolves at copy time)
5. Original custom_components/ and hacs.json removed from repo root
6. Python braces (dict, f-string, type hints) are preserved verbatim in .jinja files
7. .copier-answers.yml template uses [[ _copier_answers|to_nice_yaml ]] in content
</verification>

<success_criteria>
- copier.yml is valid YAML with all required Copier settings and project questions
- template/ directory mirrors the original file structure with .jinja suffixes and variable substitutions
- No Python brace collision — f-strings, dict literals, and type hints are intact in all .jinja Python files
- The answers file template will produce .copier-answers.yml with a DO NOT EDIT warning
</success_criteria>

<output>
After completion, create `.planning/phases/02-copier-template-scaffolding/02-01-SUMMARY.md`
</output>
