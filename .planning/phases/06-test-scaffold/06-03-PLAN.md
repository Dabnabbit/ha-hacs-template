---
phase: 06-test-scaffold
plan: 03
type: execute
wave: 3
depends_on:
  - 06-01
  - 06-02
files_modified:
  - "template/tests/[% if use_websocket %]test_websocket.py[% endif %].jinja"
autonomous: true
requirements:
  - TEST-04

must_haves:
  truths:
    - "When use_websocket=true, test_websocket.py is generated in the tests/ directory"
    - "When use_websocket=false, no test_websocket.py file exists in the tests/ directory"
    - "Copier smoke test with all-OFF flags generates pyproject.toml, tests/__init__.py, conftest.py, test_config_flow.py, test_coordinator.py but NOT test_websocket.py"
    - "Copier smoke test with all-ON flags generates all test files INCLUDING test_websocket.py"
  artifacts:
    - path: "template/tests/[% if use_websocket %]test_websocket.py[% endif %].jinja"
      provides: "Conditional WebSocket command test"
      contains: "test_websocket_get_data"
  key_links:
    - from: "template/tests/[% if use_websocket %]test_websocket.py[% endif %].jinja"
      to: "copier.yml use_websocket question"
      via: "Copier conditional filename [% if %] pattern"
      pattern: "use_websocket"
    - from: "template/tests/[% if use_websocket %]test_websocket.py[% endif %].jinja"
      to: "custom_components.domain.coordinator.ApiClient.async_get_data"
      via: "unittest.mock.patch for integration setup"
      pattern: "patch.*coordinator.ApiClient.async_get_data"
---

<objective>
Create the conditional test_websocket.py template (generated only when use_websocket=true) and validate all Phase 6 test files via copier smoke tests with both all-OFF and all-ON flag combinations.

Purpose: Conditional test files must match conditional source modules — when a feature is selected, its tests ship; when deselected, no test file appears. The smoke test validates the complete test scaffold renders correctly.
Output: Conditional test_websocket.py.jinja template file. Copier smoke tests confirm correct conditional file inclusion/exclusion.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-test-scaffold/06-RESEARCH.md
@.planning/phases/06-test-scaffold/06-01-SUMMARY.md
@.planning/phases/06-test-scaffold/06-02-SUMMARY.md
@template/custom_components/[[ project_domain ]]/[% if use_websocket %]websocket.py[% endif %].jinja
@copier.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conditional test_websocket.py.jinja</name>
  <files>template/tests/[% if use_websocket %]test_websocket.py[% endif %].jinja</files>
  <action>
Create the conditional test file using the proven Copier filename pattern: `template/tests/[% if use_websocket %]test_websocket.py[% endif %].jinja`

This is the EXACT same pattern used in Phase 5 for source modules (e.g., `[% if use_websocket %]websocket.py[% endif %].jinja`). The entire filename `test_websocket.py` goes inside the `[% if %]` block; only `.jinja` suffix is outside.

File content — a single test case verifying the WebSocket command handler works end-to-end:

```python
"""Tests for [[ project_name ]] WebSocket commands."""

from unittest.mock import AsyncMock, patch

from homeassistant.const import CONF_API_KEY, CONF_HOST, CONF_PORT
from homeassistant.core import HomeAssistant

from pytest_homeassistant_custom_component.common import MockConfigEntry

from custom_components.[[ project_domain ]].const import DOMAIN


async def test_websocket_get_data(hass: HomeAssistant, hass_ws_client) -> None:
    """Test the WebSocket get_data command returns coordinator data."""
    entry = MockConfigEntry(
        domain=DOMAIN,
        data={CONF_HOST: "192.168.1.100", CONF_PORT: 8080, CONF_API_KEY: "test-key"},
    )
    entry.add_to_hass(hass)

    with patch(
        "custom_components.[[ project_domain ]].coordinator.ApiClient.async_get_data",
        new_callable=AsyncMock,
        return_value={"sensor_value": 42},
    ):
        assert await hass.config_entries.async_setup(entry.entry_id)
        await hass.async_block_till_done()

    client = await hass_ws_client(hass)
    await client.send_json({"id": 1, "type": f"{DOMAIN}/get_data"})
    result = await client.receive_json()

    assert result["success"] is True
    assert result["result"] == {"sensor_value": 42}
```

Key points:
- `hass_ws_client` is a fixture from pytest-homeassistant-custom-component (re-exported from HA core). Research confidence is MEDIUM on exact fixture name — if unavailable at execution time, fall back to verifying command registration via `hass.data` inspection (noted in research Open Question 1).
- The test does a full integration setup (`async_setup(entry.entry_id)`) because WebSocket handlers are registered in `async_setup` and need a live integration context.
- Mock patches `coordinator.ApiClient.async_get_data` to prevent real API calls during setup.
- Uses `[[ project_domain ]]` Copier variables in patch targets and imports.
  </action>
  <verify>
- File exists at the correct conditional path: `ls template/tests/\[%\ if\ use_websocket\ %\]test_websocket.py\[%\ endif\ %\].jinja`
- `grep "test_websocket_get_data" template/tests/*websocket*` confirms test function exists
- `grep "hass_ws_client" template/tests/*websocket*` confirms WS fixture usage
  </verify>
  <done>Conditional test_websocket.py.jinja exists with correct [% if use_websocket %] filename pattern and contains a WebSocket command test case</done>
</task>

<task type="auto">
  <name>Task 2: Copier smoke test — all-OFF and all-ON validation</name>
  <files></files>
  <action>
Run two copier smoke tests to validate the complete test scaffold renders correctly. This follows the same pattern used in Phases 2, 3, 4, and 5.

**Prerequisite:** Advance git tag 0.1.0 to HEAD so copier uses the latest template files:
```bash
git tag -f 0.1.0 HEAD
```

**Smoke test 1: all-OFF (default flags)**
```bash
copier copy --defaults --data project_domain=test_integration --data project_name="Test Integration" --data author_name=testuser --data use_websocket=false --data use_services=false --data use_secondary_coordinator=false --data use_multi_step_config_flow=false . /tmp/test-scaffold-off --trust
```

Verify:
- `test -f /tmp/test-scaffold-off/pyproject.toml` — pytest config exists
- `grep "asyncio_mode" /tmp/test-scaffold-off/pyproject.toml` — confirms auto mode
- `test -f /tmp/test-scaffold-off/tests/__init__.py` — package marker exists
- `test -f /tmp/test-scaffold-off/tests/conftest.py` — conftest exists
- `test -f /tmp/test-scaffold-off/tests/test_config_flow.py` — always-on test exists
- `test -f /tmp/test-scaffold-off/tests/test_coordinator.py` — always-on test exists
- `test ! -f /tmp/test-scaffold-off/tests/test_websocket.py` — conditional test ABSENT (use_websocket=false)
- `grep "test_integration" /tmp/test-scaffold-off/tests/conftest.py` — domain substituted
- `grep "test_integration" /tmp/test-scaffold-off/tests/test_config_flow.py` — domain substituted

**Smoke test 2: all-ON (all flags true)**
```bash
copier copy --defaults --data project_domain=test_integration --data project_name="Test Integration" --data author_name=testuser --data use_websocket=true --data use_services=true --data use_secondary_coordinator=true --data use_multi_step_config_flow=true . /tmp/test-scaffold-on --trust
```

Verify:
- All checks from smoke test 1 pass
- `test -f /tmp/test-scaffold-on/tests/test_websocket.py` — conditional test PRESENT (use_websocket=true)
- `grep "test_integration" /tmp/test-scaffold-on/tests/test_websocket.py` — domain substituted

**Cleanup:**
```bash
rm -rf /tmp/test-scaffold-off /tmp/test-scaffold-on
```

If any check fails, diagnose and fix the template file before continuing. Common issues: Copier variable not rendering (wrong delimiter), conditional filename pattern wrong (file appears when it shouldn't or vice versa).
  </action>
  <verify>
All copier smoke test checks pass:
- All-OFF: 7 file checks (6 present, 1 absent)
- All-ON: 8 file checks (7 present including test_websocket.py)
- Copier variable `[[ project_domain ]]` rendered to `test_integration` in all test files
  </verify>
  <done>Copier smoke tests pass for both all-OFF (no test_websocket.py) and all-ON (test_websocket.py present) flag combinations; all Copier variables correctly rendered</done>
</task>

</tasks>

<verification>
1. Conditional test file uses correct `[% if use_websocket %]test_websocket.py[% endif %].jinja` filename pattern
2. Copier all-OFF smoke test: test_websocket.py absent, all other test files present
3. Copier all-ON smoke test: test_websocket.py present alongside all other test files
4. All `[[ project_domain ]]` variables rendered correctly in generated files
5. No Jinja2 artifacts (`[[`, `[%`, `]]`, `%]`) remain in generated output
</verification>

<success_criteria>
- Conditional test_websocket.py.jinja exists with correct filename pattern
- Copier smoke tests pass: conditional file inclusion/exclusion works for tests
- All test template files render with correct domain variable substitution
- TEST-04 requirement addressed
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-scaffold/06-03-SUMMARY.md`
</output>
