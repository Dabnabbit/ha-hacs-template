---
phase: 07-cicd-and-hacs-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - template/.github/workflows/validate.yml
  - template/.gitignore
autonomous: true
requirements:
  - CICD-01
  - CICD-02
  - CICD-03
  - CICD-04

must_haves:
  truths:
    - "Generated project contains a .github/workflows/validate.yml that defines hassfest and HACS validation jobs"
    - "Generated project .gitignore excludes Python bytecode, IDE files, OS artifacts, and test artifacts"
    - "Generated project README.md contains HACS badge, setup instructions, and card usage section with domain name"
    - "validate.yml uses SHA-pinned actions matching HACS community convention (two separate jobs)"
  artifacts:
    - path: "template/.github/workflows/validate.yml"
      provides: "GitHub Actions validate workflow with hassfest + HACS action"
      contains: "hacs/action"
    - path: "template/.gitignore"
      provides: "Python/IDE/OS/test artifact exclusions"
      contains: ".pytest_cache"
    - path: "template/README.md.jinja"
      provides: "HACS badge, setup instructions, card usage"
      contains: "HACS"
  key_links:
    - from: "template/.github/workflows/validate.yml"
      to: "home-assistant/actions/hassfest"
      via: "uses directive in hassfest job"
      pattern: "home-assistant/actions/hassfest@"
    - from: "template/.github/workflows/validate.yml"
      to: "hacs/action"
      via: "uses directive in hacs job"
      pattern: "hacs/action@"
---

<objective>
Create the validate.yml GitHub Actions workflow and finalize .gitignore for generated projects. README.md.jinja already satisfies CICD-03 (verified in research) and requires no changes. CICD-02 (release workflow) is descoped per user decision — deferred to per-project setup.

Purpose: Generated child projects get HACS-compliant CI validation out of the box and a clean .gitignore covering all artifact types.
Output: template/.github/workflows/validate.yml (new), template/.gitignore (updated)
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cicd-and-hacs-distribution/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validate.yml workflow and update .gitignore</name>
  <files>template/.github/workflows/validate.yml, template/.gitignore</files>
  <action>
Create `template/.github/workflows/validate.yml` as a STATIC file (no .jinja suffix — no Copier variables needed). Use the exact pattern from ludeeus/integration_blueprint (the authoritative HACS community template):

```yaml
name: Validate

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions: {}

jobs:
  hassfest:
    name: Hassfest validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run hassfest validation
        uses: home-assistant/actions/hassfest@55b4a5d23e09d627c2773c2ef82afa98904d65b4 # master

  hacs:
    name: HACS validation
    runs-on: ubuntu-latest
    steps:
      - name: Run HACS validation
        uses: hacs/action@d556e736723344f83838d08488c983a15381059a # 22.5.0
        with:
          category: integration
          ignore: brands
```

Key points:
- `permissions: {}` — deny-by-default security posture
- `ignore: brands` — prevents CI failure before brand images submitted to home-assistant/brands
- `checkout` only on hassfest job — HACS action fetches repo via Docker internally
- Two separate jobs for independent pass/fail status on PRs
- SHA-pinned actions with version comments
- No .jinja suffix — workflow contains zero Copier variables

Then update `template/.gitignore` to append test artifact patterns after existing content:

```
# Test artifacts
.pytest_cache/
.coverage
coverage.xml
htmlcov/
```

Keep all existing entries unchanged. Add the test artifact block at the end.

Do NOT modify template/README.md.jinja — research confirmed it already satisfies CICD-03 (has HACS badge, setup instructions, card usage with domain substitution).

CICD-02 (release workflow) is descoped per user decision — do NOT create release.yml.
  </action>
  <verify>
Verify the files exist and have correct content:
- `ls template/.github/workflows/validate.yml` — file exists
- `grep "hassfest" template/.github/workflows/validate.yml` — hassfest job present
- `grep "hacs/action" template/.github/workflows/validate.yml` — HACS action present
- `grep "permissions: {}" template/.github/workflows/validate.yml` — security posture set
- `grep "ignore: brands" template/.github/workflows/validate.yml` — brands ignore present
- `grep ".pytest_cache" template/.gitignore` — test artifacts added
- `grep ".coverage" template/.gitignore` — coverage artifact added
- `grep "__pycache__" template/.gitignore` — existing entries preserved
  </verify>
  <done>
validate.yml exists with two SHA-pinned jobs (hassfest + HACS), empty permissions, brands ignore. .gitignore has all original entries plus test artifact exclusions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Copier smoke test — validate.yml in generated output</name>
  <files></files>
  <action>
Run a copier copy smoke test to verify the generated project includes validate.yml and updated .gitignore:

1. Advance git tag 0.1.0 to HEAD (copier uses tagged version):
   ```bash
   git tag -f 0.1.0 HEAD
   ```

2. Run copier copy with all-OFF defaults:
   ```bash
   copier copy --defaults --data project_name="Test Project" --data project_domain="test_project" --data project_description="Test" --data documentation_url="https://example.com" --data issue_tracker_url="https://example.com" . /tmp/smoke-test-07
   ```

3. Verify generated output:
   - `ls /tmp/smoke-test-07/.github/workflows/validate.yml` — workflow file present
   - `grep "hassfest" /tmp/smoke-test-07/.github/workflows/validate.yml` — hassfest job present
   - `grep "hacs/action" /tmp/smoke-test-07/.github/workflows/validate.yml` — HACS action present
   - `grep ".pytest_cache" /tmp/smoke-test-07/.gitignore` — test artifacts present
   - `grep "__pycache__" /tmp/smoke-test-07/.gitignore` — existing entries preserved
   - `ls /tmp/smoke-test-07/README.md` — README rendered (not .jinja)
   - `grep "Test Project" /tmp/smoke-test-07/README.md` — Copier variables substituted
   - `grep "HACS" /tmp/smoke-test-07/README.md` — HACS badge present

4. Clean up: `rm -rf /tmp/smoke-test-07`
  </action>
  <verify>
All 8 smoke test checks pass: validate.yml present with both jobs, .gitignore has test artifacts and original entries, README.md rendered with Copier variables and HACS badge.
  </verify>
  <done>
Copier-generated project includes .github/workflows/validate.yml (static, verbatim copy), updated .gitignore with test artifacts, and README.md with HACS badge and project-specific content. Phase 7 requirements satisfied: CICD-01 (validate workflow), CICD-02 (descoped per user decision), CICD-03 (README already complete), CICD-04 (.gitignore updated).
  </done>
</task>

</tasks>

<verification>
1. `template/.github/workflows/validate.yml` exists as static file with hassfest + HACS action two-job pattern
2. `template/.gitignore` includes test artifact exclusions (.pytest_cache, .coverage, coverage.xml, htmlcov)
3. `template/README.md.jinja` unchanged — already satisfies CICD-03
4. No release.yml created (CICD-02 descoped per user decision)
5. Copier smoke test generates all three files correctly in child project
</verification>

<success_criteria>
- validate.yml has two separate jobs with SHA-pinned actions, empty permissions, brands ignore
- .gitignore covers Python, IDE, OS, and test artifacts
- README.md renders with HACS badge, setup instructions, and card usage
- copier copy generates all distribution files in correct locations
- No release workflow exists (per user decision to defer)
</success_criteria>

<output>
After completion, create `.planning/phases/07-cicd-and-hacs-distribution/07-01-SUMMARY.md`
</output>
