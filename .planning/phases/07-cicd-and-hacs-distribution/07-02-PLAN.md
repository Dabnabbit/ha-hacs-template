---
phase: 07-cicd-and-hacs-distribution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - template/custom_components/[[ project_domain ]]/manifest.json.jinja
  - template/custom_components/[[ project_domain ]]/__init__.py.jinja
autonomous: true
gap_closure: true
requirements: [CICD-01]

must_haves:
  truths:
    - "Generated project passes hassfest validation without errors on a clean push (no missing dependency or CONFIG_SCHEMA warnings)"
    - "manifest.json includes 'http' in dependencies array alongside 'frontend'"
    - "__init__.py declares CONFIG_SCHEMA = cv.config_entry_only_config_schema(DOMAIN) for config-entry-only compliance"
  artifacts:
    - path: "template/custom_components/[[ project_domain ]]/manifest.json.jinja"
      provides: "Complete dependency list including http"
      contains: '"http"'
    - path: "template/custom_components/[[ project_domain ]]/__init__.py.jinja"
      provides: "CONFIG_SCHEMA declaration for hassfest compliance"
      contains: "CONFIG_SCHEMA"
  key_links:
    - from: "template/custom_components/[[ project_domain ]]/__init__.py.jinja"
      to: "homeassistant.components.http"
      via: "manifest.json dependencies array"
      pattern: '"http"'
    - from: "template/custom_components/[[ project_domain ]]/__init__.py.jinja"
      to: "homeassistant.helpers.config_validation"
      via: "import and CONFIG_SCHEMA assignment"
      pattern: "config_entry_only_config_schema"
---

<objective>
Fix two hassfest validation failures in generated projects: (1) add missing "http" dependency to manifest.json.jinja, (2) add CONFIG_SCHEMA declaration to __init__.py.jinja.

Purpose: UAT test 6 revealed that a clean generated project fails hassfest CI — the validate.yml workflow (CICD-01) cannot pass until these template-level issues are resolved. Both are Jinja template edits preserving Copier's `[% %]` / `[[ ]]` delimiters.

Output: Two corrected template files that produce hassfest-clean generated projects.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cicd-and-hacs-distribution/07-UAT.md
@.planning/phases/07-cicd-and-hacs-distribution/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix manifest.json.jinja and __init__.py.jinja for hassfest compliance</name>
  <files>
    template/custom_components/[[ project_domain ]]/manifest.json.jinja
    template/custom_components/[[ project_domain ]]/__init__.py.jinja
  </files>
  <action>
**Fix 1 — manifest.json.jinja: Add "http" to dependencies**

In `template/custom_components/[[ project_domain ]]/manifest.json.jinja`, change the dependencies line from:

```
"dependencies": ["frontend"[% if use_websocket %], "websocket_api"[% endif %]],
```

to:

```
"dependencies": ["frontend", "http"[% if use_websocket %], "websocket_api"[% endif %]],
```

This adds `"http"` as an unconditional dependency. The template uses `async_register_static_paths` from `homeassistant.components.http` in `__init__.py.jinja` — hassfest checks direct imports and requires every imported HA component to appear in `dependencies`. The `"frontend"` dependency does NOT transitively cover `"http"`.

**Fix 2 — __init__.py.jinja: Add CONFIG_SCHEMA declaration**

In `template/custom_components/[[ project_domain ]]/__init__.py.jinja`, make two changes:

(a) Add the `config_validation` import. After the existing line:

```python
from homeassistant.core import HomeAssistant
```

Add:

```python
from homeassistant.helpers import config_validation as cv
```

(b) Add the CONFIG_SCHEMA declaration. After the existing line:

```python
PLATFORMS: list[Platform] = [Platform.SENSOR]
```

Add:

```python
CONFIG_SCHEMA = cv.config_entry_only_config_schema(DOMAIN)
```

This declares that the integration is config-entry-only, which hassfest requires for integrations that define `async_setup` alongside `config_flow: true` in the manifest. The `cv` import comes from `homeassistant.helpers.config_validation`, which is the standard HA helper module.

**IMPORTANT — Copier delimiter preservation:**
- Both files use `[% %]` for block tags and `[[ ]]` for variable expressions (NOT `{% %}` or `{{ }}`)
- The new lines are plain Python — no Copier variables or conditionals needed
- Do NOT add `{% raw %}` blocks — these files use _envops custom delimiters exclusively
- Do NOT change any existing `[% if ... %]` or `[[ ... ]]` expressions
  </action>
  <verify>
Run a Copier smoke test to confirm the generated output is correct:

```bash
COPIER=$(which copier 2>/dev/null || find / -name copier -type f -executable 2>/dev/null | head -1)
rm -rf /tmp/uat-gap-07-02
$COPIER copy --defaults --data project_domain=test_integration --data author_name=testuser /home/dab/Projects/ha-hacs-template /tmp/uat-gap-07-02

# Verify manifest.json has "http" in dependencies
grep -q '"http"' /tmp/uat-gap-07-02/custom_components/test_integration/manifest.json && echo "PASS: http in manifest" || echo "FAIL: http missing"

# Verify __init__.py has CONFIG_SCHEMA
grep -q 'CONFIG_SCHEMA' /tmp/uat-gap-07-02/custom_components/test_integration/__init__.py && echo "PASS: CONFIG_SCHEMA present" || echo "FAIL: CONFIG_SCHEMA missing"

# Verify __init__.py has cv import
grep -q 'config_validation as cv' /tmp/uat-gap-07-02/custom_components/test_integration/__init__.py && echo "PASS: cv import present" || echo "FAIL: cv import missing"

# Verify dependencies is valid JSON array (no trailing comma, no syntax error)
python3 -c "import json; m=json.load(open('/tmp/uat-gap-07-02/custom_components/test_integration/manifest.json')); assert 'http' in m['dependencies'] and 'frontend' in m['dependencies']; print('PASS: manifest JSON valid')"

# Also test with websocket enabled
rm -rf /tmp/uat-gap-07-02-ws
$COPIER copy --defaults --data project_domain=test_integration --data author_name=testuser --data use_websocket=true /home/dab/Projects/ha-hacs-template /tmp/uat-gap-07-02-ws
python3 -c "import json; m=json.load(open('/tmp/uat-gap-07-02-ws/custom_components/test_integration/manifest.json')); deps=m['dependencies']; assert 'http' in deps and 'frontend' in deps and 'websocket_api' in deps; print('PASS: websocket manifest JSON valid with all 3 deps')"
```

All checks must print PASS.
  </verify>
  <done>
    - manifest.json.jinja dependencies array includes "frontend", "http", and conditionally "websocket_api"
    - __init__.py.jinja imports config_validation as cv and declares CONFIG_SCHEMA = cv.config_entry_only_config_schema(DOMAIN)
    - Generated projects (both default and websocket-enabled) produce valid JSON manifest with correct dependencies
    - Generated __init__.py contains CONFIG_SCHEMA declaration
  </done>
</task>

</tasks>

<verification>
1. Copier smoke test (default options): generated manifest.json contains `"http"` in dependencies; generated __init__.py contains `CONFIG_SCHEMA` and `config_validation as cv`
2. Copier smoke test (websocket enabled): generated manifest.json contains `"frontend"`, `"http"`, and `"websocket_api"` in dependencies
3. Both generated manifest.json files are valid JSON (no syntax errors from comma placement)
4. No existing Copier delimiters (`[% %]`, `[[ ]]`) broken in either template file
</verification>

<success_criteria>
- Generated project from clean `copier copy --defaults` produces a manifest.json with "http" in dependencies
- Generated project __init__.py declares CONFIG_SCHEMA = cv.config_entry_only_config_schema(DOMAIN)
- Both fixes resolve the two hassfest errors reported in UAT test 6
</success_criteria>

<output>
After completion, create `.planning/phases/07-cicd-and-hacs-distribution/07-02-SUMMARY.md`
</output>
