---
phase: 03-backend-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - template/custom_components/[[ project_domain ]]/api.py.jinja
  - template/custom_components/[[ project_domain ]]/coordinator.py.jinja
  - template/custom_components/[[ project_domain ]]/const.py.jinja
autonomous: true
requirements:
  - BACK-01
  - BACK-02
  - BACK-03

must_haves:
  truths:
    - "ApiClient class exists with configurable auth, timeout, and error handling"
    - "Coordinator creates ApiClient from entry.data and uses it in _async_update_data"
    - "ApiClient exceptions (CannotConnectError, InvalidAuthError) are distinct from config_flow exceptions"
    - "const.py exports DOMAIN, DEFAULT_PORT, DEFAULT_SCAN_INTERVAL, DEFAULT_TIMEOUT, FRONTEND_SCRIPT_URL only (CONF_* removed)"
  artifacts:
    - path: "template/custom_components/[[ project_domain ]]/api.py.jinja"
      provides: "ApiClient base class with auth, timeout, error handling"
      contains: "class ApiClient"
    - path: "template/custom_components/[[ project_domain ]]/coordinator.py.jinja"
      provides: "Coordinator wired to ApiClient"
      contains: "ApiClient"
    - path: "template/custom_components/[[ project_domain ]]/const.py.jinja"
      provides: "Constants including DEFAULT_TIMEOUT"
      contains: "DEFAULT_TIMEOUT"
  key_links:
    - from: "template/custom_components/[[ project_domain ]]/coordinator.py.jinja"
      to: "template/custom_components/[[ project_domain ]]/api.py.jinja"
      via: "from .api import ApiClient, CannotConnectError"
      pattern: "from \\.api import"
    - from: "template/custom_components/[[ project_domain ]]/coordinator.py.jinja"
      to: "homeassistant.const"
      via: "CONF_HOST, CONF_PORT, CONF_API_KEY imports"
      pattern: "from homeassistant\\.const import"
---

<objective>
Create the ApiClient base class template and wire it into the coordinator.

Purpose: BACK-01 requires a generic API client with configurable auth, timeout, and error handling. BACK-02 requires the coordinator to use the API client from runtime_data. BACK-03 (typed ConfigEntry) is already complete but is verified here since the coordinator depends on it.

Output: api.py.jinja (new), updated coordinator.py.jinja, updated const.py.jinja
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-core/03-RESEARCH.md

@template/custom_components/[[ project_domain ]]/coordinator.py.jinja
@template/custom_components/[[ project_domain ]]/const.py.jinja
@template/custom_components/[[ project_domain ]]/__init__.py.jinja
@copier.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create api.py.jinja and update const.py.jinja</name>
  <files>
    template/custom_components/[[ project_domain ]]/api.py.jinja
    template/custom_components/[[ project_domain ]]/const.py.jinja
  </files>
  <action>
Create NEW file `template/custom_components/[[ project_domain ]]/api.py.jinja` with the ApiClient class.

IMPORTANT: This is a Copier template file using custom delimiters:
- Variables: [[ variable_name ]]
- Logic: [% if condition %] ... [% endif %]
- Python braces `{}` are LITERAL (not Jinja2) -- use them normally for dicts, f-strings, sets

The file must contain:
1. Module docstring: `"""API client for [[ project_name ]]."""`
2. Imports: `from __future__ import annotations`, `asyncio`, `logging`, `typing.Any`, `aiohttp`
3. `_LOGGER = logging.getLogger(__name__)`
4. `class CannotConnectError(Exception)` -- raised on connection/timeout failures
5. `class InvalidAuthError(Exception)` -- raised on 401/403 responses
6. `class ApiClient` with:
   - `__init__(self, host: str, port: int, api_key: str, session: aiohttp.ClientSession, timeout: int = DEFAULT_TIMEOUT) -> None`
   - Stores `_base_url = f"http://{host}:{port}"`, `_api_key`, `_session`, `_timeout = aiohttp.ClientTimeout(total=timeout)`
   - `_get_auth_headers(self) -> dict[str, str]` returning `{"Authorization": f"Bearer {self._api_key}"}` -- docstring says "Override to use query param or body auth instead"
   - `async _request(self, method: str, endpoint: str, **kwargs: Any) -> dict[str, Any]` -- makes authenticated request, catches `aiohttp.ClientConnectionError` -> `CannotConnectError`, `aiohttp.ClientError` -> `CannotConnectError`, `asyncio.TimeoutError` -> `CannotConnectError`, checks `response.status in (401, 403)` -> `InvalidAuthError`, calls `response.raise_for_status()` then `response.json()`
   - `async async_test_connection(self) -> bool` -- calls `_request("GET", "/health")` with TODO comment to replace endpoint
   - `async async_get_data(self) -> dict[str, Any]` -- calls `_request("GET", "/api/data")` with TODO comment to replace endpoint
7. Import `DEFAULT_TIMEOUT` from `.const` -- NOT from `homeassistant.const`

For const.py.jinja:
- Read the existing file first
- REMOVE the three local CONF_* lines: `CONF_HOST = "host"`, `CONF_PORT = "port"`, `CONF_API_KEY = "api_key"` -- these shadow `homeassistant.const` and cause import confusion (see Research Pitfall 1)
- ADD `DEFAULT_TIMEOUT = 30` after DEFAULT_SCAN_INTERVAL
- Keep DOMAIN, DEFAULT_PORT, DEFAULT_SCAN_INTERVAL, FRONTEND_SCRIPT_URL unchanged
  </action>
  <verify>
Verify api.py.jinja contains `class ApiClient`, `class CannotConnectError`, `class InvalidAuthError`, `async_test_connection`, `async_get_data`, and imports `DEFAULT_TIMEOUT` from `.const`.
Verify const.py.jinja has `DEFAULT_TIMEOUT = 30` and does NOT contain `CONF_HOST`, `CONF_PORT`, or `CONF_API_KEY`.
  </verify>
  <done>
api.py.jinja exists with complete ApiClient class including auth headers, timeout, error handling, test_connection, and get_data methods. const.py.jinja has DEFAULT_TIMEOUT and no shadowed CONF_* constants.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ApiClient into coordinator.py.jinja</name>
  <files>
    template/custom_components/[[ project_domain ]]/coordinator.py.jinja
  </files>
  <action>
Read existing coordinator.py.jinja then update it to wire the ApiClient.

Changes to make:
1. Add import: `from homeassistant.const import CONF_HOST, CONF_PORT, CONF_API_KEY` (import from homeassistant.const, NOT from .const -- the local CONF_* have been removed from const.py)
2. Add import: `from .api import ApiClient, CannotConnectError`
3. In `__init__`: Replace the TODO comment block with actual ApiClient initialization:
   ```
   self.client = ApiClient(
       host=entry.data[CONF_HOST],
       port=entry.data[CONF_PORT],
       api_key=entry.data[CONF_API_KEY],
       session=session,
   )
   ```
   The `session = async_get_clientsession(hass)` line already exists -- keep it.
4. In `_async_update_data`: Replace the TODO/placeholder with:
   ```
   try:
       return await self.client.async_get_data()
   except CannotConnectError as err:
       raise UpdateFailed(f"Error communicating with API: {err}") from err
   ```
   Remove the `data: dict[str, Any] = {}` placeholder and the generic `except Exception`.

Keep the existing `config_entry: ConfigEntry` class attribute. Keep the `DataUpdateCoordinator[dict[str, Any]]` generic type parameter. Keep all existing imports that are still used.

IMPORTANT: All Python braces `{}` are literal in Jinja2 -- they render as-is with the custom _envops delimiters. No escaping needed.
  </action>
  <verify>
Verify coordinator.py.jinja:
- Contains `from .api import ApiClient, CannotConnectError`
- Contains `from homeassistant.const import CONF_HOST, CONF_PORT, CONF_API_KEY`
- Contains `self.client = ApiClient(`
- Contains `await self.client.async_get_data()`
- Contains `except CannotConnectError as err`
- Does NOT contain `data: dict[str, Any] = {}` placeholder
- Does NOT contain `# TODO: Initialize your API client`
  </verify>
  <done>
Coordinator creates ApiClient from entry.data (host, port, api_key) and uses it in _async_update_data, catching CannotConnectError and raising UpdateFailed.
  </done>
</task>

</tasks>

<verification>
- api.py.jinja is valid Jinja2 with [[ ]] variable syntax (only [[ project_name ]] in docstring)
- coordinator.py.jinja imports from .api and homeassistant.const
- const.py.jinja has no CONF_* constants (they live in homeassistant.const now)
- No circular imports: api.py imports from .const only, coordinator.py imports from .api and .const
</verification>

<success_criteria>
- ApiClient class is fully implemented with auth, timeout, error handling, test_connection, and get_data
- Coordinator uses ApiClient to fetch data and translates CannotConnectError to UpdateFailed
- const.py.jinja cleaned of shadowed CONF_* constants, DEFAULT_TIMEOUT added
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-core/03-01-SUMMARY.md`
</output>
