---
phase: 03-backend-core
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - template/custom_components/[[ project_domain ]]/sensor.py.jinja
autonomous: true
requirements:
  - BACK-04
  - BACK-05
  - BACK-07
  - BACK-08
  - BACK-10

must_haves:
  truths:
    - "Sensor entity has _attr_device_info with DeviceEntryType.SERVICE and identifiers tied to entry"
    - "PARALLEL_UPDATES = 0 is set at module level in sensor.py"
    - "manifest.json.jinja has all required hassfest fields"
    - "hacs.json.jinja has name and homeassistant minimum version"
  artifacts:
    - path: "template/custom_components/[[ project_domain ]]/sensor.py.jinja"
      provides: "Sensor with device_info and PARALLEL_UPDATES"
      contains: "PARALLEL_UPDATES = 0"
    - path: "template/custom_components/[[ project_domain ]]/sensor.py.jinja"
      provides: "DeviceInfo with SERVICE entry type"
      contains: "DeviceEntryType.SERVICE"
    - path: "template/custom_components/[[ project_domain ]]/manifest.json.jinja"
      provides: "Complete hassfest-valid manifest"
      contains: "integration_type"
    - path: "template/hacs.json.jinja"
      provides: "HACS metadata with minimum HA version"
      contains: "homeassistant"
  key_links:
    - from: "template/custom_components/[[ project_domain ]]/sensor.py.jinja"
      to: "homeassistant.helpers.device_registry"
      via: "DeviceEntryType, DeviceInfo imports"
      pattern: "from homeassistant\\.helpers\\.device_registry import"
    - from: "template/custom_components/[[ project_domain ]]/sensor.py.jinja"
      to: "template/custom_components/[[ project_domain ]]/const.py.jinja"
      via: "DOMAIN import for device identifiers"
      pattern: "from \\.const import DOMAIN"
---

<objective>
Add device registry integration and PARALLEL_UPDATES to the sensor template; verify manifest and HACS metadata are complete.

Purpose: BACK-04 completes the sensor entity pattern, BACK-05 adds DeviceEntryType.SERVICE for device registry, BACK-10 adds PARALLEL_UPDATES = 0 for quality scale compliance. BACK-07 and BACK-08 are verification-only (templates already correct from Phase 1/2).

Output: Updated sensor.py.jinja with device_info and PARALLEL_UPDATES
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-core/03-RESEARCH.md

@template/custom_components/[[ project_domain ]]/sensor.py.jinja
@template/custom_components/[[ project_domain ]]/manifest.json.jinja
@template/hacs.json.jinja
@template/custom_components/[[ project_domain ]]/const.py.jinja
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add device_info and PARALLEL_UPDATES to sensor.py.jinja</name>
  <files>
    template/custom_components/[[ project_domain ]]/sensor.py.jinja
  </files>
  <action>
Read existing sensor.py.jinja then update it with the following changes:

IMPORTANT: This is a Copier template file using custom delimiters:
- Variables: [[ variable_name ]]
- Python braces `{}` are LITERAL (not Jinja2)

Changes to make:

1. ADD imports:
   - `from homeassistant.helpers.device_registry import DeviceEntryType, DeviceInfo`
   Keep existing imports: `SensorEntity`, `ConfigEntry`, `HomeAssistant`, `AddEntitiesCallback`, `CoordinatorEntity`.

2. ADD `from .const import DOMAIN` to the imports from `.const`. Currently sensor.py.jinja has no import from .const -- add it.

3. ADD module-level constant AFTER all imports but BEFORE the `async_setup_entry` function:
   ```
   PARALLEL_UPDATES = 0
   ```
   This must be at module level (not inside a class). Put it after all import blocks with a blank line before and after.

4. In `TemplateSensor.__init__`, ADD `_attr_device_info` after the existing `_attr_name` line:
   ```
   self._attr_device_info = DeviceInfo(
       identifiers={(DOMAIN, entry.entry_id)},
       entry_type=DeviceEntryType.SERVICE,
       name=entry.title,
       manufacturer="[[ project_name ]]",
   )
   ```
   Note: `{(DOMAIN, entry.entry_id)}` is a Python set literal containing a tuple -- braces are LITERAL in the Copier template, not Jinja2 syntax. `[[ project_name ]]` is the Copier variable.

5. Keep the existing `native_value` property unchanged.

6. Keep the existing `async_setup_entry` function and `TemplateSensor` class structure unchanged except for the additions above.

Do NOT change the import of `[[ project_domain | replace('_', ' ') | title | replace(' ', '') ]]ConfigEntry` from `. import` -- it must stay as-is (it's the typed ConfigEntry from __init__.py).
  </action>
  <verify>
Verify sensor.py.jinja contains:
- `from homeassistant.helpers.device_registry import DeviceEntryType, DeviceInfo`
- `from .const import DOMAIN`
- `PARALLEL_UPDATES = 0` at module level
- `_attr_device_info = DeviceInfo(` inside TemplateSensor.__init__
- `DeviceEntryType.SERVICE` in the DeviceInfo constructor
- `identifiers={(DOMAIN, entry.entry_id)}` (set of tuple, not dict)
- `[[ project_name ]]` as manufacturer value (Copier variable)
- Existing `native_value` property preserved
- Existing `async_setup_entry` function preserved
  </verify>
  <done>
sensor.py.jinja has PARALLEL_UPDATES = 0 at module level and _attr_device_info with DeviceEntryType.SERVICE, DOMAIN-based identifiers, and [[ project_name ]] manufacturer.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify manifest.json.jinja and hacs.json.jinja completeness</name>
  <files>
    template/custom_components/[[ project_domain ]]/manifest.json.jinja
    template/hacs.json.jinja
  </files>
  <action>
Read both files and verify they satisfy BACK-07 and BACK-08 requirements. These files should already be correct from Phase 1/2, but we must confirm.

**manifest.json.jinja (BACK-07)** must have ALL these fields:
- `"domain"` -- [[ project_domain ]]
- `"name"` -- [[ project_name ]]
- `"codeowners"` -- array with @[[ author_name ]]
- `"config_flow"` -- true
- `"dependencies"` -- ["frontend"]
- `"documentation"` -- [[ documentation_url ]]
- `"integration_type"` -- [[ integration_type ]]
- `"iot_class"` -- [[ iot_class ]]
- `"issue_tracker"` -- [[ issue_tracker_url ]] (field name is "issue_tracker" NOT "issue_tracker_url")
- `"requirements"` -- []
- `"version"` -- [[ version ]]

IMPORTANT: There is NO `homeassistant` field in manifest.json (that's only in hacs.json). Do NOT add one.

**hacs.json.jinja (BACK-08)** must have:
- `"name"` -- [[ project_name ]]
- `"homeassistant"` -- "2025.7.0"
- `"render_readme"` -- true

If both files are already correct (they should be), log this as "verified, no changes needed" in the summary. If anything is missing or wrong, fix it.
  </action>
  <verify>
Read manifest.json.jinja and confirm all 11 required fields are present.
Read hacs.json.jinja and confirm name + homeassistant fields are present.
  </verify>
  <done>
manifest.json.jinja has all 11 hassfest-required fields. hacs.json.jinja has name and homeassistant minimum version. Both verified correct.
  </done>
</task>

</tasks>

<verification>
- sensor.py.jinja has PARALLEL_UPDATES = 0 at module level (BACK-10)
- sensor.py.jinja has DeviceInfo with DeviceEntryType.SERVICE (BACK-05)
- sensor.py.jinja has _attr_has_entity_name, _attr_unique_id, _attr_device_info (BACK-04)
- manifest.json.jinja has all required fields (BACK-07)
- hacs.json.jinja has name and homeassistant (BACK-08)
</verification>

<success_criteria>
- sensor.py.jinja adds PARALLEL_UPDATES = 0, DeviceInfo with DeviceEntryType.SERVICE
- manifest.json.jinja and hacs.json.jinja verified complete
- All Python braces in sensor.py.jinja are literal (no Jinja2 escaping issues)
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-core/03-02-SUMMARY.md`
</output>
