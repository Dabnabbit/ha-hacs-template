---
phase: 06-test-scaffold
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - template/pyproject.toml.jinja
  - template/tests/__init__.py.jinja
  - template/tests/conftest.py.jinja
autonomous: true
requirements:
  - TEST-01
  - TEST-05

must_haves:
  truths:
    - "pytest discovers and runs async tests in a freshly generated project with zero additional configuration"
    - "conftest.py auto-enables custom integration loading for every test via autouse fixture"
    - "conftest.py provides mock_setup_entry fixture that prevents full integration setup during config flow tests"
  artifacts:
    - path: "template/pyproject.toml.jinja"
      provides: "pytest configuration with asyncio_mode=auto and test dependency"
      contains: "asyncio_mode"
    - path: "template/tests/__init__.py.jinja"
      provides: "Python package marker for test discovery"
    - path: "template/tests/conftest.py.jinja"
      provides: "autouse enable_custom_integrations fixture and mock_setup_entry fixture"
      contains: "auto_enable_custom_integrations"
  key_links:
    - from: "template/pyproject.toml.jinja"
      to: "pytest-homeassistant-custom-component"
      via: "optional-dependencies declaration"
      pattern: "pytest-homeassistant-custom-component"
    - from: "template/tests/conftest.py.jinja"
      to: "enable_custom_integrations"
      via: "autouse fixture wrapping pytest-homeassistant-custom-component fixture"
      pattern: "auto_enable_custom_integrations.*enable_custom_integrations"
---

<objective>
Create the pytest infrastructure template files: pyproject.toml with pytest configuration, tests/__init__.py for package discovery, and tests/conftest.py with HA test fixtures.

Purpose: A freshly generated project must run `pytest` out of the box with async test support and custom integration loading enabled — this is the foundation all test files depend on.
Output: Three .jinja template files in template/ that Copier renders into a working pytest setup.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-test-scaffold/06-RESEARCH.md
@copier.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pyproject.toml.jinja and tests/__init__.py.jinja</name>
  <files>template/pyproject.toml.jinja, template/tests/__init__.py.jinja</files>
  <action>
Create `template/pyproject.toml.jinja` at the template root (same level as hacs.json.jinja) with minimal pytest configuration:

```toml
[tool.pytest.ini_options]
asyncio_mode = "auto"
testpaths = ["tests"]

[project.optional-dependencies]
test = [
    "pytest-homeassistant-custom-component",
]
```

Key points:
- `asyncio_mode = "auto"` is MANDATORY — without it, pytest-asyncio refuses to run async tests without per-function decorators (Pitfall 1 from research)
- `testpaths = ["tests"]` ensures pytest discovers the tests/ directory
- No `[build-system]` section needed — generated projects are not Python packages
- `pytest-homeassistant-custom-component` is the sole test dependency (it pulls in pytest, pytest-asyncio, and all HA test fixtures transitively)

Create `template/tests/__init__.py.jinja` with a single comment line:

```python
# Tests package
```

This ensures Copier renders a non-empty `tests/__init__.py` file (Pitfall 5 from research: empty files might not render). The file is required for pytest to discover tests in the `tests/` directory.
  </action>
  <verify>
Both files exist at the correct paths:
- `ls template/pyproject.toml.jinja` succeeds
- `ls template/tests/__init__.py.jinja` succeeds
- `grep "asyncio_mode" template/pyproject.toml.jinja` returns the auto setting
  </verify>
  <done>pyproject.toml.jinja contains asyncio_mode=auto and pytest-homeassistant-custom-component dependency; tests/__init__.py.jinja exists as non-empty package marker</done>
</task>

<task type="auto">
  <name>Task 2: Create tests/conftest.py.jinja with HA fixtures</name>
  <files>template/tests/conftest.py.jinja</files>
  <action>
Create `template/tests/conftest.py.jinja` with two fixtures:

1. **auto_enable_custom_integrations** (autouse=True): Wraps the `enable_custom_integrations` fixture from pytest-homeassistant-custom-component. Without this, HA's loader will not find the generated integration during tests.

2. **mock_setup_entry**: Patches `custom_components.[[ project_domain ]].async_setup_entry` to return True, preventing full integration setup during config flow tests. Returns the AsyncMock so tests can assert `mock_setup_entry.mock_calls`.

Complete file content:

```python
"""Common fixtures for the [[ project_name ]] tests."""

from collections.abc import Generator
from unittest.mock import AsyncMock, patch

import pytest


@pytest.fixture(autouse=True)
def auto_enable_custom_integrations(enable_custom_integrations):
    """Enable custom integrations for all tests in this package."""
    yield


@pytest.fixture
def mock_setup_entry() -> Generator[AsyncMock]:
    """Override async_setup_entry to prevent full integration setup during config flow tests."""
    with patch(
        "custom_components.[[ project_domain ]].async_setup_entry",
        return_value=True,
    ) as mock_setup_entry:
        yield mock_setup_entry
```

Key points:
- Uses `[[ project_domain ]]` Copier variable for the patch target path (rendered to actual domain by Copier)
- `Generator[AsyncMock]` return type annotation (modern Python typing, no need for Generator[AsyncMock, None, None])
- `enable_custom_integrations` is a fixture name from pytest-homeassistant-custom-component — do NOT import it, pytest discovers it automatically
- The mock_setup_entry fixture is NOT autouse — only config flow tests request it explicitly
  </action>
  <verify>
- `grep "auto_enable_custom_integrations" template/tests/conftest.py.jinja` confirms the autouse fixture
- `grep "mock_setup_entry" template/tests/conftest.py.jinja` confirms the setup entry mock
- `grep "\[\[ project_domain \]\]" template/tests/conftest.py.jinja` confirms Copier variable substitution in patch target
  </verify>
  <done>conftest.py.jinja contains autouse enable_custom_integrations fixture and mock_setup_entry fixture with correct Copier variable in patch target path</done>
</task>

</tasks>

<verification>
1. All three template files exist under template/:
   - `template/pyproject.toml.jinja`
   - `template/tests/__init__.py.jinja`
   - `template/tests/conftest.py.jinja`
2. pyproject.toml.jinja has `asyncio_mode = "auto"` and `pytest-homeassistant-custom-component`
3. conftest.py.jinja has both fixtures with `[[ project_domain ]]` Copier variable
4. No raw `{{ }}` Jinja2 syntax (would conflict with _envops `[[ ]]` delimiters)
</verification>

<success_criteria>
- pyproject.toml.jinja, tests/__init__.py.jinja, and tests/conftest.py.jinja exist with correct content
- All Copier variables use `[[ ]]` delimiters (not `{{ }}`)
- No Python brace patterns corrupted by template syntax
- TEST-01 and TEST-05 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-scaffold/06-01-SUMMARY.md`
</output>
