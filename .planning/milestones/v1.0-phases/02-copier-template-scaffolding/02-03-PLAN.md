---
phase: 02-copier-template-scaffolding
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - "template/custom_components/[[ project_domain ]]/[% if use_multi_step_config_flow %]config_flow_multi_step.py[% endif %].jinja"
autonomous: true
requirements:
  - COPR-05
gap_closure: true

must_haves:
  truths:
    - "When use_multi_step_config_flow=true, config_flow_multi_step.py appears in the generated project"
    - "When use_multi_step_config_flow=false, config_flow_multi_step.py is absent from the generated project"
    - "The generated config_flow_multi_step.py contains valid Python (passes py_compile)"
  artifacts:
    - path: "template/custom_components/[[ project_domain ]]/[% if use_multi_step_config_flow %]config_flow_multi_step.py[% endif %].jinja"
      provides: "Conditional multi-step config flow placeholder stub for Phase 5"
      contains: "project_name"
  key_links:
    - from: "copier.yml use_multi_step_config_flow question"
      to: "[% if use_multi_step_config_flow %]config_flow_multi_step.py[% endif %].jinja"
      via: "Copier conditional filename rendering"
      pattern: "use_multi_step_config_flow"
---

<objective>
Close COPR-05 gap: add the missing conditional template file for `use_multi_step_config_flow` so the copier.yml question is wired to an actual template artifact.

Purpose: The `use_multi_step_config_flow` question exists in copier.yml (line 76) but no conditional template file references it. COPR-05 requires all four conditional files (websocket, services, coordinator_secondary, multi-step config_flow) to be generated or excluded based on question answers. Three of four are done; this closes the last one.

Output: A conditional stub file matching the established pattern, verified via copier copy with the flag on and off.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-copier-template-scaffolding/02-02-SUMMARY.md
@.planning/phases/02-copier-template-scaffolding/02-VERIFICATION.md

# Existing conditional stubs to match pattern exactly
@template/custom_components/[[ project_domain ]]/[% if use_websocket %]websocket.py[% endif %].jinja
@template/custom_components/[[ project_domain ]]/[% if use_services %]services.py[% endif %].jinja
@template/custom_components/[[ project_domain ]]/[% if use_secondary_coordinator %]coordinator_secondary.py[% endif %].jinja
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conditional multi-step config flow stub template</name>
  <files>template/custom_components/[[ project_domain ]]/[% if use_multi_step_config_flow %]config_flow_multi_step.py[% endif %].jinja</files>
  <action>
Create the file `template/custom_components/[[ project_domain ]]/[% if use_multi_step_config_flow %]config_flow_multi_step.py[% endif %].jinja` as a minimal stub placeholder, matching the exact pattern of the three existing conditional stubs (websocket.py, services.py, coordinator_secondary.py).

Content should be:

```python
"""Multi-step config flow for the [[ project_name ]] integration."""

from __future__ import annotations

# TODO: Implement multi-step config flow (Phase 5)
# See: homeassistant.config_entries.ConfigFlow
```

Key constraints:
- Filename MUST use the proven pattern: `[% if use_multi_step_config_flow %]config_flow_multi_step.py[% endif %].jinja` — entire base+extension inside the `[% if %]` block, only `.jinja` outside. This was corrected during 02-02 execution (per user decision on conditional filename pattern).
- File content uses `[[ project_name ]]` for Copier variable substitution (per _envops `[[ ]]` delimiter decision).
- This is a Phase 2 stub only — actual multi-step config flow implementation happens in Phase 5. The TODO comment signals this.
- The file MUST be a valid Python file after Copier renders it (no Jinja2 artifacts left in generated output).
  </action>
  <verify>
1. File exists at the correct path: `ls "template/custom_components/[[ project_domain ]]/[% if use_multi_step_config_flow %]config_flow_multi_step.py[% endif %].jinja"`
2. File contains `[[ project_name ]]` substitution variable
3. File contains `# TODO:` comment referencing Phase 5
  </verify>
  <done>The conditional template file exists in the domain directory with the correct `[% if %]` filename pattern and stub content matching the established pattern from 02-02.</done>
</task>

<task type="auto">
  <name>Task 2: Smoke-test multi-step config flow conditional inclusion and exclusion</name>
  <files>template/custom_components/[[ project_domain ]]/[% if use_multi_step_config_flow %]config_flow_multi_step.py[% endif %].jinja</files>
  <action>
Run two copier copy tests to verify the conditional file is correctly wired:

1. **Exclusion test (flag=false):** Run `copier copy` with `use_multi_step_config_flow=false` (or `--defaults` since default is false). Verify that `config_flow_multi_step.py` does NOT appear in the generated output directory.

2. **Inclusion test (flag=true):** Run `copier copy` with `use_multi_step_config_flow=true`. Verify that `config_flow_multi_step.py` DOES appear in the generated output directory. Then run `python -m py_compile` on the generated file to confirm it is valid Python.

Use the copier binary at `/home/dab/mediaparser-venv/bin/copier` (installed during 02-02 execution). Use a temp directory for output. Use `--defaults` for all other questions or provide minimal required answers (project_domain=test_integration, author_name=testuser).

If the git tag 0.1.0 needs to be moved to include the new file, move it: `git tag -f 0.1.0` (copier requires the tag for version anchoring).

Important: After moving the tag, the smoke test must use the local repo path (not a remote), so copier reads the current commit state.
  </action>
  <verify>
1. Exclusion: `ls /tmp/verify-gap-default/custom_components/test_integration/config_flow_multi_step.py` returns "No such file"
2. Inclusion: `ls /tmp/verify-gap-flag/custom_components/test_integration/config_flow_multi_step.py` returns the file
3. `python3 -m py_compile /tmp/verify-gap-flag/custom_components/test_integration/config_flow_multi_step.py` exits 0
  </verify>
  <done>copier copy with use_multi_step_config_flow=true generates config_flow_multi_step.py (valid Python); copier copy with use_multi_step_config_flow=false omits it entirely. COPR-05 fully satisfied.</done>
</task>

</tasks>

<verification>
1. All four conditional files now exist in `template/custom_components/[[ project_domain ]]/`:
   - `[% if use_websocket %]websocket.py[% endif %].jinja` (from 02-02)
   - `[% if use_services %]services.py[% endif %].jinja` (from 02-02)
   - `[% if use_secondary_coordinator %]coordinator_secondary.py[% endif %].jinja` (from 02-02)
   - `[% if use_multi_step_config_flow %]config_flow_multi_step.py[% endif %].jinja` (NEW)
2. Each conditional file is wired to its corresponding `copier.yml` question
3. Copier copy confirms inclusion/exclusion behavior for the new file
</verification>

<success_criteria>
- COPR-05 fully satisfied: all four conditional files listed in the requirement are present and working
- `use_multi_step_config_flow=true` generates config_flow_multi_step.py
- `use_multi_step_config_flow=false` omits config_flow_multi_step.py
- Generated file passes py_compile
</success_criteria>

<output>
After completion, create `.planning/phases/02-copier-template-scaffolding/02-03-SUMMARY.md`
</output>
