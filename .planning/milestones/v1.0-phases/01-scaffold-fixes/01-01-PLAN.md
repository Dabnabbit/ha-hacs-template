---
phase: 01-scaffold-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - custom_components/hacs_template/const.py
  - custom_components/hacs_template/__init__.py
  - custom_components/hacs_template/coordinator.py
  - custom_components/hacs_template/sensor.py
  - hacs.json
autonomous: true
requirements:
  - SCAF-01
  - SCAF-02
  - SCAF-04
  - SCAF-07
  - SCAF-08

must_haves:
  truths:
    - "Static path is registered once in async_setup, not per config entry"
    - "Coordinator data is stored on entry.runtime_data, not hass.data[DOMAIN]"
    - "async_unload_entry has no hass.data cleanup, only async_unload_platforms"
    - "Coordinator uses async_get_clientsession(hass), not raw aiohttp.ClientSession"
    - "Frontend JS URL uses /{DOMAIN}/ prefix, not /hacsfiles/"
    - "hacs.json requires HA 2025.7.0 minimum"
  artifacts:
    - path: "custom_components/hacs_template/__init__.py"
      provides: "async_setup with StaticPathConfig, async_setup_entry with runtime_data, clean async_unload_entry"
      contains: "async_register_static_paths"
    - path: "custom_components/hacs_template/__init__.py"
      provides: "HacsTemplateData dataclass and HacsTemplateConfigEntry type alias"
      contains: "HacsTemplateConfigEntry"
    - path: "custom_components/hacs_template/coordinator.py"
      provides: "Coordinator using HA-managed HTTP session"
      contains: "async_get_clientsession"
    - path: "custom_components/hacs_template/sensor.py"
      provides: "Sensor platform accessing coordinator via runtime_data"
      contains: "entry.runtime_data.coordinator"
    - path: "custom_components/hacs_template/const.py"
      provides: "Correct frontend URL prefix"
      contains: "/{DOMAIN}/"
    - path: "hacs.json"
      provides: "Correct HA minimum version"
      contains: "2025.7.0"
  key_links:
    - from: "custom_components/hacs_template/__init__.py"
      to: "homeassistant.components.http.StaticPathConfig"
      via: "import and async_register_static_paths call in async_setup"
      pattern: "async_register_static_paths.*StaticPathConfig"
    - from: "custom_components/hacs_template/__init__.py"
      to: "custom_components/hacs_template/coordinator.py"
      via: "HacsTemplateData dataclass storing coordinator in runtime_data"
      pattern: "entry\\.runtime_data\\s*=\\s*HacsTemplateData"
    - from: "custom_components/hacs_template/sensor.py"
      to: "custom_components/hacs_template/__init__.py"
      via: "HacsTemplateConfigEntry type alias import for typed runtime_data access"
      pattern: "entry\\.runtime_data\\.coordinator"
    - from: "custom_components/hacs_template/coordinator.py"
      to: "homeassistant.helpers.aiohttp_client"
      via: "async_get_clientsession import and call"
      pattern: "async_get_clientsession\\(hass\\)"
---

<objective>
Fix the integration core: static path registration, runtime data storage, HTTP session management, and version metadata.

Purpose: The current scaffold uses removed/deprecated HA APIs (register_static_path removed in 2025.7, hass.data[DOMAIN] anti-pattern, raw aiohttp sessions). These five changes make __init__.py, coordinator.py, sensor.py, and const.py use only current HA APIs. Without this, the integration does not load at all on HA 2025.7+.

Output: Working __init__.py with async_setup + runtime_data pattern, coordinator.py with managed HTTP session, sensor.py with typed runtime_data access, corrected URL prefix in const.py, and updated hacs.json version.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-scaffold-fixes/01-RESEARCH.md
@custom_components/hacs_template/__init__.py
@custom_components/hacs_template/coordinator.py
@custom_components/hacs_template/sensor.py
@custom_components/hacs_template/const.py
@hacs.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix __init__.py — add async_setup with StaticPathConfig, migrate to runtime_data, clean unload</name>
  <files>
    custom_components/hacs_template/__init__.py
    custom_components/hacs_template/const.py
    hacs.json
  </files>
  <action>
**const.py** — Change the FRONTEND_SCRIPT_URL from `/hacsfiles/{DOMAIN}/{DOMAIN}-card.js` to `/{DOMAIN}/{DOMAIN}-card.js`. The `/hacsfiles/` prefix is HACS-owned namespace; integration-bundled cards must use `/{DOMAIN}/` per community developer guide. Keep everything else unchanged.

**hacs.json** — Change the `homeassistant` field from `"2024.1.0"` to `"2025.7.0"`. The `async_register_static_paths` API requires HA 2025.7+, so the minimum version must reflect that.

**__init__.py** — Full rewrite of this file. The new version must:

1. Add imports: `StaticPathConfig` from `homeassistant.components.http`, `dataclass` from `dataclasses`.

2. Add a `HacsTemplateData` dataclass with a single field `coordinator: TemplateCoordinator`.

3. Add a type alias: `type HacsTemplateConfigEntry = ConfigEntry[HacsTemplateData]`.

4. Add `async_setup(hass: HomeAssistant, config: dict) -> bool` function that:
   - Constructs the frontend path via `Path(__file__).parent / "frontend"`
   - Calls `await hass.http.async_register_static_paths([StaticPathConfig(...)])` with the URL from `FRONTEND_SCRIPT_URL`, the path to `{DOMAIN}-card.js`, and `cache_headers=True`
   - Wraps the call in `try/except RuntimeError` to handle "path already registered" on reload
   - Returns `True`

5. Change `async_setup_entry` signature to use `HacsTemplateConfigEntry` instead of `ConfigEntry`. Remove ALL `hass.data` usage. After `coordinator.async_config_entry_first_refresh()`, set `entry.runtime_data = HacsTemplateData(coordinator=coordinator)`. Remove the `_async_register_frontend` call (static path registration moved to `async_setup`). Keep `async_forward_entry_setups` call.

6. Change `async_unload_entry` signature to use `HacsTemplateConfigEntry`. Remove the `hass.data[DOMAIN].pop(entry.entry_id)` line. The function body should ONLY be: `return await hass.config_entries.async_unload_platforms(entry, PLATFORMS)`. No conditional, no hass.data cleanup — runtime_data is auto-cleaned.

7. Remove the entire `_async_register_frontend` helper function.

8. Remove the `FRONTEND_SCRIPT_URL` import from const (no longer needed in __init__.py since `async_setup` uses it directly — actually keep it, `async_setup` still needs the URL). Keep the import.

Do NOT add `homeassistant` minimum version to `manifest.json` — that field is optional for custom integrations and not required for Phase 1.
  </action>
  <verify>
Run: `python -c "import ast; ast.parse(open('custom_components/hacs_template/__init__.py').read()); print('VALID')"` — must print VALID.

Grep checks:
- `grep -c "async_register_static_paths" custom_components/hacs_template/__init__.py` returns >= 1
- `grep -c "StaticPathConfig" custom_components/hacs_template/__init__.py` returns >= 1
- `grep -c "async_setup" custom_components/hacs_template/__init__.py` returns >= 1 (the function def, not just async_setup_entry)
- `grep -c "runtime_data" custom_components/hacs_template/__init__.py` returns >= 1
- `grep -c "hass.data" custom_components/hacs_template/__init__.py` returns 0 (no hass.data usage remaining)
- `grep -c "register_static_path(" custom_components/hacs_template/__init__.py` returns 0 (old sync method gone; note the opening paren to avoid matching async_register_static_paths)
- `grep -c "_async_register_frontend" custom_components/hacs_template/__init__.py` returns 0
- `grep "FRONTEND_SCRIPT_URL" custom_components/hacs_template/const.py` shows the /{DOMAIN}/ prefix, not /hacsfiles/
- `grep "homeassistant" hacs.json` shows "2025.7.0"
  </verify>
  <done>
__init__.py has async_setup with StaticPathConfig registration (wrapped in try/except RuntimeError), async_setup_entry stores coordinator in entry.runtime_data via HacsTemplateData dataclass, async_unload_entry only calls async_unload_platforms with no hass.data cleanup. const.py uses /{DOMAIN}/ URL prefix. hacs.json requires HA 2025.7.0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix coordinator.py and sensor.py — managed HTTP session and typed runtime_data access</name>
  <files>
    custom_components/hacs_template/coordinator.py
    custom_components/hacs_template/sensor.py
  </files>
  <action>
**coordinator.py** — Add `from homeassistant.helpers.aiohttp_client import async_get_clientsession` import. In `__init__`, after `self.config_entry = entry`, add `session = async_get_clientsession(hass)`. Update the TODO comment to show that the session should be passed to the API client: `# TODO: Initialize your API client here using the managed session` / `# self.client = MyApiClient(host=..., port=..., session=session)`. Do NOT create a raw `aiohttp.ClientSession()` anywhere. Keep the existing `_async_update_data` method unchanged (it already has a TODO for the real API call). The `session` variable will be unused for now (just assigned) — this is intentional; the TODO comment guides child projects to pass it to their API client.

**sensor.py** — Replace `hass.data[DOMAIN][entry.entry_id]` with `entry.runtime_data.coordinator`. This requires:
1. Add import: `from . import HacsTemplateConfigEntry` (import the type alias from __init__.py)
2. Change the `entry` parameter type in `async_setup_entry` from `ConfigEntry` to `HacsTemplateConfigEntry`
3. Replace `coordinator: TemplateCoordinator = hass.data[DOMAIN][entry.entry_id]` with `coordinator = entry.runtime_data.coordinator`
4. Remove the `from .const import DOMAIN` import (no longer needed — DOMAIN was only used for `hass.data[DOMAIN]`)
5. Remove `from homeassistant.config_entries import ConfigEntry` import (replaced by HacsTemplateConfigEntry)
6. Keep the `TemplateSensor` class unchanged — it still receives `coordinator` and `entry` as constructor params. The `entry` param type in `TemplateSensor.__init__` can remain `ConfigEntry` (it only uses `entry.entry_id` which is available on both types).
  </action>
  <verify>
Run: `python -c "import ast; ast.parse(open('custom_components/hacs_template/coordinator.py').read()); print('VALID')"` — must print VALID.
Run: `python -c "import ast; ast.parse(open('custom_components/hacs_template/sensor.py').read()); print('VALID')"` — must print VALID.

Grep checks:
- `grep -c "async_get_clientsession" custom_components/hacs_template/coordinator.py` returns >= 1
- `grep -c "aiohttp.ClientSession" custom_components/hacs_template/coordinator.py` returns 0
- `grep -c "runtime_data" custom_components/hacs_template/sensor.py` returns >= 1
- `grep -c "hass.data" custom_components/hacs_template/sensor.py` returns 0
- `grep -c "HacsTemplateConfigEntry" custom_components/hacs_template/sensor.py` returns >= 1
  </verify>
  <done>
coordinator.py imports and calls async_get_clientsession(hass) with a clear TODO for child projects to pass the session to their API client. sensor.py uses entry.runtime_data.coordinator via the HacsTemplateConfigEntry type alias; no hass.data[DOMAIN] usage remains.
  </done>
</task>

</tasks>

<verification>
All five source files modified in this plan should:
1. Parse as valid Python (ast.parse succeeds)
2. Contain zero references to `hass.data[DOMAIN]`
3. Contain zero references to `register_static_path(` (the old sync method)
4. Contain zero references to `/hacsfiles/`
5. __init__.py must define both `async_setup` and `async_setup_entry` as separate functions
6. __init__.py must define `HacsTemplateData` dataclass and `HacsTemplateConfigEntry` type alias
</verification>

<success_criteria>
- async_setup exists and registers static path via async_register_static_paths + StaticPathConfig
- Static path registration is domain-level (async_setup), not per-entry (async_setup_entry)
- entry.runtime_data stores HacsTemplateData with coordinator; no hass.data usage anywhere
- async_unload_entry only calls async_unload_platforms; no manual data cleanup
- coordinator.py uses async_get_clientsession(hass); no raw aiohttp session
- sensor.py accesses coordinator via entry.runtime_data.coordinator with typed config entry
- const.py frontend URL uses /{DOMAIN}/ prefix
- hacs.json homeassistant field is "2025.7.0"
</success_criteria>

<output>
After completion, create `.planning/phases/01-scaffold-fixes/01-01-SUMMARY.md`
</output>
