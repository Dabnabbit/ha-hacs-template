---
phase: 01-scaffold-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - custom_components/hacs_template/config_flow.py
  - custom_components/hacs_template/strings.json
  - custom_components/hacs_template/translations/en.json
autonomous: true
requirements:
  - SCAF-03
  - SCAF-05
  - SCAF-06

must_haves:
  truths:
    - "Config flow sets unique_id from host:port and aborts on duplicate"
    - "Config flow validates connection with CannotConnect and InvalidAuth exception handling"
    - "Options flow opens using OptionsFlow base class with no __init__ config_entry assignment"
    - "Options flow strings render in HA UI (strings.json and translations/en.json have options section)"
  artifacts:
    - path: "custom_components/hacs_template/config_flow.py"
      provides: "Config flow with unique_id, validation, and options flow"
      contains: "async_set_unique_id"
    - path: "custom_components/hacs_template/config_flow.py"
      provides: "OptionsFlowHandler using OptionsFlow base"
      contains: "class OptionsFlowHandler(OptionsFlow)"
    - path: "custom_components/hacs_template/config_flow.py"
      provides: "Connection validation exceptions"
      contains: "class CannotConnect"
    - path: "custom_components/hacs_template/strings.json"
      provides: "Options flow UI strings"
      contains: "options"
    - path: "custom_components/hacs_template/translations/en.json"
      provides: "Options flow translated strings"
      contains: "options"
  key_links:
    - from: "custom_components/hacs_template/config_flow.py"
      to: "homeassistant.config_entries.OptionsFlow"
      via: "import and subclass"
      pattern: "class OptionsFlowHandler\\(OptionsFlow\\)"
    - from: "custom_components/hacs_template/config_flow.py"
      to: "async_set_unique_id + _abort_if_unique_id_configured"
      via: "called in async_step_user before async_create_entry"
      pattern: "async_set_unique_id.*_abort_if_unique_id_configured"
    - from: "custom_components/hacs_template/config_flow.py"
      to: "custom_components/hacs_template/strings.json"
      via: "error keys (cannot_connect, invalid_auth, unknown) and abort keys (already_configured) map to strings.json"
      pattern: "errors\\[.base.\\]\\s*=\\s*.cannot_connect."
    - from: "custom_components/hacs_template/config_flow.py"
      to: "TemplateConfigFlow.async_get_options_flow"
      via: "static method returns OptionsFlowHandler() with no arguments"
      pattern: "return OptionsFlowHandler\\(\\)"
---

<objective>
Fix the config flow: add duplicate entry prevention, connection validation, and a modern options flow.

Purpose: The current config_flow.py has no unique_id (allows duplicate entries), commented-out validation (never catches connection errors), and no options flow at all (users cannot reconfigure after setup). These are the remaining three scaffold defects blocking Quality Scale Bronze compliance and HACS reviewer approval.

Output: Config flow with unique_id + abort-on-duplicate, active connection validation stub with proper exception handling, OptionsFlowHandler using the OptionsFlow base class, and matching strings/translations for the options flow UI.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-scaffold-fixes/01-RESEARCH.md
@custom_components/hacs_template/config_flow.py
@custom_components/hacs_template/strings.json
@custom_components/hacs_template/translations/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite config_flow.py — unique_id, validation, and options flow</name>
  <files>custom_components/hacs_template/config_flow.py</files>
  <action>
Rewrite `config_flow.py` with these specific changes:

**New imports (add to existing):**
- `from homeassistant.config_entries import ConfigEntry, ConfigFlow, ConfigFlowResult, OptionsFlow`
- `from homeassistant.core import callback`

**Add exception classes** (before the config flow class):
```python
class CannotConnect(Exception):
    """Error to indicate we cannot connect."""

class InvalidAuth(Exception):
    """Error to indicate there is invalid auth."""
```

**Add validation stub** (module-level async function):
```python
async def _async_validate_connection(user_input: dict) -> None:
    """Validate the user can connect to the service.

    Raise CannotConnect or InvalidAuth on failure.
    """
    # TODO: Replace with actual connection test in child projects
    # session = async_get_clientsession(hass)
    # client = MyApiClient(user_input[CONF_HOST], session)
    # await client.async_test_connection()
    pass
```

**Modify `async_step_user`** — After `if user_input is not None:`, add (before validation):
```python
await self.async_set_unique_id(
    f"{user_input[CONF_HOST]}:{user_input[CONF_PORT]}"
)
self._abort_if_unique_id_configured()
```

Then replace the commented-out validation block with active code:
```python
try:
    await _async_validate_connection(user_input)
except CannotConnect:
    errors["base"] = "cannot_connect"
except InvalidAuth:
    errors["base"] = "invalid_auth"
except Exception:
    _LOGGER.exception("Unexpected exception")
    errors["base"] = "unknown"
else:
    return self.async_create_entry(
        title=user_input[CONF_HOST],
        data=user_input,
    )
```

Remove the old `if not errors:` / `return self.async_create_entry(...)` block — the `else` clause on the try/except now handles entry creation.

**Add `async_get_options_flow`** as a static method on `TemplateConfigFlow`:
```python
@staticmethod
@callback
def async_get_options_flow(
    config_entry: ConfigEntry,
) -> OptionsFlowHandler:
    """Create the options flow."""
    return OptionsFlowHandler()
```

Note: The `config_entry` parameter MUST be present in the signature (HA calls it with this argument) but MUST NOT be passed to the constructor. `OptionsFlowHandler()` takes zero arguments.

**Add `OptionsFlowHandler` class** (after TemplateConfigFlow):
```python
class OptionsFlowHandler(OptionsFlow):
    """Handle options flow for HACS Template."""

    async def async_step_init(
        self, user_input: dict[str, Any] | None = None
    ) -> ConfigFlowResult:
        """Manage the options."""
        if user_input is not None:
            return self.async_create_entry(data=user_input)

        return self.async_show_form(
            step_id="init",
            data_schema=vol.Schema(
                {
                    vol.Optional(
                        CONF_HOST,
                        default=self.config_entry.data.get(CONF_HOST, ""),
                    ): str,
                    vol.Optional(
                        CONF_PORT,
                        default=self.config_entry.data.get(CONF_PORT, DEFAULT_PORT),
                    ): int,
                }
            ),
        )
```

Key points:
- Do NOT define `__init__` on OptionsFlowHandler — the OptionsFlow base class provides `self.config_entry` automatically
- Do NOT pass `config_entry` to the OptionsFlowHandler constructor
- Use `self.config_entry.data.get(...)` for defaults (provided by base class)
- Import `CONF_HOST` from `homeassistant.const` (already imported) and keep `CONF_PORT` import as well (also already from homeassistant.const... actually check: current file imports CONF_HOST and CONF_PORT from homeassistant.const). Also import DEFAULT_PORT from .const (already imported).
  </action>
  <verify>
Run: `python -c "import ast; ast.parse(open('custom_components/hacs_template/config_flow.py').read()); print('VALID')"` — must print VALID.

Grep checks:
- `grep -c "async_set_unique_id" custom_components/hacs_template/config_flow.py` returns >= 1
- `grep -c "_abort_if_unique_id_configured" custom_components/hacs_template/config_flow.py` returns >= 1
- `grep -c "class CannotConnect" custom_components/hacs_template/config_flow.py` returns 1
- `grep -c "class InvalidAuth" custom_components/hacs_template/config_flow.py` returns 1
- `grep -c "_async_validate_connection" custom_components/hacs_template/config_flow.py` returns >= 2 (definition + call)
- `grep -c "class OptionsFlowHandler(OptionsFlow)" custom_components/hacs_template/config_flow.py` returns 1
- `grep -c "async_get_options_flow" custom_components/hacs_template/config_flow.py` returns >= 1
- `grep -c "self.config_entry = config_entry" custom_components/hacs_template/config_flow.py` returns 0 (must NOT have manual assignment)
- `grep -c "def __init__" custom_components/hacs_template/config_flow.py` returns 0 (OptionsFlowHandler must not have __init__)
- `grep -c "return OptionsFlowHandler()" custom_components/hacs_template/config_flow.py` returns 1 (no arguments!)
  </verify>
  <done>
config_flow.py has: CannotConnect and InvalidAuth exception classes, _async_validate_connection stub, async_set_unique_id with host:port + _abort_if_unique_id_configured before entry creation, active try/except validation block, async_get_options_flow static method returning OptionsFlowHandler() with no arguments, and OptionsFlowHandler class extending OptionsFlow base with async_step_init (no __init__, no manual config_entry assignment).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add options flow strings to strings.json and translations/en.json</name>
  <files>
    custom_components/hacs_template/strings.json
    custom_components/hacs_template/translations/en.json
  </files>
  <action>
Both files currently have only a `"config"` section. Add an `"options"` section to both files (they must be identical).

The new `"options"` section structure:
```json
{
  "config": { ... existing content unchanged ... },
  "options": {
    "step": {
      "init": {
        "title": "Update Service Settings",
        "data": {
          "host": "Host",
          "port": "Port"
        }
      }
    }
  }
}
```

The options step ID is `"init"` — matching the `async_step_init` method in `OptionsFlowHandler`. The data keys `"host"` and `"port"` match `CONF_HOST` and `CONF_PORT` used in the options flow schema. The labels match the existing config flow labels for consistency.

Do NOT modify the existing `"config"` section content — it already has the correct error and abort strings (`cannot_connect`, `invalid_auth`, `unknown`, `already_configured`).

Both `strings.json` and `translations/en.json` must have identical content after this change.
  </action>
  <verify>
Run: `python -c "import json; d=json.load(open('custom_components/hacs_template/strings.json')); assert 'options' in d; assert 'init' in d['options']['step']; assert 'host' in d['options']['step']['init']['data']; print('VALID')"` — must print VALID.

Run: `python -c "import json; s=json.load(open('custom_components/hacs_template/strings.json')); t=json.load(open('custom_components/hacs_template/translations/en.json')); assert s == t; print('MATCH')"` — must print MATCH.

Run: `python -c "import json; d=json.load(open('custom_components/hacs_template/strings.json')); assert 'cannot_connect' in d['config']['error']; print('EXISTING OK')"` — must print EXISTING OK (existing config section preserved).
  </verify>
  <done>
strings.json and translations/en.json both have an "options" section with step "init" containing "host" and "port" data labels. The existing "config" section (with error and abort strings) is preserved unchanged. Both files are identical.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. All three modified files parse correctly (Python ast.parse for config_flow.py, JSON parse for strings/translations)
2. config_flow.py contains async_set_unique_id, _abort_if_unique_id_configured, CannotConnect, InvalidAuth, OptionsFlowHandler(OptionsFlow), and async_get_options_flow
3. config_flow.py does NOT contain `self.config_entry = config_entry` or `OptionsFlowHandler(config_entry)`
4. strings.json and translations/en.json both have "options" section with "init" step
5. strings.json and translations/en.json are identical
</verification>

<success_criteria>
- Config flow calls async_set_unique_id with f"{host}:{port}" and _abort_if_unique_id_configured before entry creation
- Connection validation stub is active (not commented out) with CannotConnect and InvalidAuth exception handling
- OptionsFlowHandler extends OptionsFlow base class with no __init__ and no manual config_entry assignment
- async_get_options_flow returns OptionsFlowHandler() with zero arguments
- Options flow strings exist in both strings.json and translations/en.json with matching content
</success_criteria>

<output>
After completion, create `.planning/phases/01-scaffold-fixes/01-02-SUMMARY.md`
</output>
