---
phase: 04-frontend-card
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - template/custom_components/[[ project_domain ]]/frontend/[[ project_domain ]]-card.js.jinja
  - template/custom_components/[[ project_domain ]]/__init__.py.jinja
autonomous: true
requirements:
  - CARD-01
  - CARD-02
  - CARD-03
  - CARD-04
  - CARD-05
  - CARD-06
  - CARD-07
  - CARD-08

must_haves:
  truths:
    - "Card shows a ha-spinner loading indicator when hass or config is not yet available"
    - "Card shows an ha-alert error message when the configured entity does not exist in hass.states"
    - "Card shows 'No entity configured' message when no entity is set in config"
    - "Card renders entity state and friendly_name when entity is available"
    - "Card editor opens and dispatches config-changed events with bubbles and composed flags"
    - "Card appears in Lovelace Add Card picker with name, description, and preview"
    - "Card uses only CSS custom properties for colors -- no hardcoded hex/rgb values"
    - "getStubConfig(hass) finds a real sensor entity as the default"
    - "getGridOptions() returns sizing for the sections view 12-column grid"
    - "customElements.define() is guarded against duplicate registration"
    - "Lovelace resource is auto-registered for storage-mode dashboards"
    - "Copier-rendered card JS parses as valid JavaScript with no Jinja2 artifacts"
  artifacts:
    - path: "template/custom_components/[[ project_domain ]]/frontend/[[ project_domain ]]-card.js.jinja"
      provides: "Complete LitElement card with editor, loading/error states, card registry, theme integration"
      contains: "ha-spinner"
    - path: "template/custom_components/[[ project_domain ]]/__init__.py.jinja"
      provides: "Lovelace resource auto-registration in async_setup"
      contains: "lovelace"
  key_links:
    - from: "card.js render()"
      to: "ha-spinner / ha-alert"
      via: "conditional rendering in render() method"
      pattern: "ha-spinner|ha-alert"
    - from: "card.js getConfigElement()"
      to: "card-editor custom element"
      via: "document.createElement returns editor"
      pattern: "getConfigElement"
    - from: "card.js window.customCards.push()"
      to: "Lovelace card picker"
      via: "type matches customElements.define name"
      pattern: "window\\.customCards\\.push"
    - from: "__init__.py async_setup()"
      to: "lovelace.resources.async_create_item()"
      via: "auto-registration for storage-mode dashboards"
      pattern: "async_create_item"
---

<objective>
Complete the Lovelace card template with loading/error states, sections view support, smart stub config, duplicate element guards, Lovelace resource auto-registration, and copier smoke test verification.

Purpose: The generated card must be production-ready: it handles all lifecycle states gracefully (loading, error, no entity, normal), appears in the card picker, renders with HA theme colors, supports both masonry and sections views, and auto-registers itself as a dashboard resource so users don't need manual configuration.

Output: Enhanced card JS template, enhanced __init__.py with auto-registration, verified copier output.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-frontend-card/04-RESEARCH.md
@template/custom_components/[[ project_domain ]]/frontend/[[ project_domain ]]-card.js.jinja
@template/custom_components/[[ project_domain ]]/__init__.py.jinja
@template/custom_components/[[ project_domain ]]/const.py.jinja
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance card JS template with loading/error states, getGridOptions, getStubConfig(hass), and duplicate guard</name>
  <files>template/custom_components/[[ project_domain ]]/frontend/[[ project_domain ]]-card.js.jinja</files>
  <action>
Rewrite the card JS template file with the following enhancements while preserving ALL existing functionality (LitElement extraction, editor class, window.customCards registration, console.info banner):

**render() method -- three-state branching (CARD-07):**
1. If `!this.hass || !this.config`: return ha-card wrapping a `<div class="card-content loading">` containing `<ha-spinner size="small"></ha-spinner>`. This is the loading state.
2. If `this.config.entity` is set but `this.hass.states[entityId]` is falsy: return ha-card with header containing `<ha-alert alert-type="error">Entity not available: ${entityId}</ha-alert>` inside card-content. This is the error state.
3. If no entity configured (`!entityId`): return ha-card with "No entity configured" empty message (already exists).
4. Normal state: entity exists, render friendly_name and state value (already exists).

**getStubConfig(hass) enhancement (CARD-04):**
Change `static getStubConfig()` to `static getStubConfig(hass)`. Body: find the first entity key starting with `"sensor."` from `Object.keys(hass.states)`. Return `{ header: "[[ project_name ]]", entity: sensorEntity || "" }`. Guard with `if (!hass)` fallback returning the same object with empty entity.

**getGridOptions() addition (CARD-05):**
Add `getGridOptions()` instance method (NOT static) after `getCardSize()`. Return `{ rows: 3, columns: 6, min_rows: 2, min_columns: 3 }`. This enables sections view (12-column grid, HA 2024.11+).

**CSS styles enhancement (CARD-06):**
Add `.loading` style: `display: flex; justify-content: center; align-items: center; padding: 32px 16px;`. Existing styles already use `var(--primary-text-color)`, `var(--primary-color)`, `var(--secondary-text-color)` -- keep those. Remove the `ha-card { padding: 16px; }` rule (ha-card handles its own padding; the extra rule creates double padding).

**Duplicate element guard (CARD-01, Pitfall 3):**
Replace the two bare `customElements.define()` calls at the bottom with guarded versions:
```
if (!customElements.get("[[ project_domain | replace('_', '-') ]]-card")) {
  customElements.define("[[ project_domain | replace('_', '-') ]]-card", ...Card);
}
if (!customElements.get("[[ project_domain | replace('_', '-') ]]-card-editor")) {
  customElements.define("[[ project_domain | replace('_', '-') ]]-card-editor", ...CardEditor);
}
```

**Preserve existing patterns (CARD-02, CARD-03, CARD-08):**
- Editor class with `getConfigElement()`, `config-changed` CustomEvent with `bubbles: true, composed: true` -- DO NOT CHANGE
- `window.customCards.push()` with type, name, description, preview: true -- DO NOT CHANGE
- `<ha-card header="...">` wrapper -- keep for all states
- All Copier template variables (`[[ project_domain ]]`, `[[ project_name ]]`, etc.) -- preserve exactly

**IMPORTANT template delimiter note:** This is a `.js.jinja` file using `[[ ]]` for Copier variables. JavaScript `${}` template literals are SAFE (not interpreted by Copier). Do NOT add `{% raw %}` blocks.
  </action>
  <verify>
Read the modified file and verify:
1. `ha-spinner` appears in a loading branch
2. `ha-alert` appears in an error branch
3. `getGridOptions()` method exists
4. `getStubConfig(hass)` accepts hass parameter
5. `customElements.get()` guard wraps both define() calls
6. No hardcoded hex/rgb color values in styles
7. All `[[ ... ]]` Copier variables are syntactically valid
8. Editor class and window.customCards registration are unchanged
  </verify>
  <done>Card JS template has loading state (ha-spinner), error state (ha-alert), getGridOptions(), getStubConfig(hass), duplicate element guards, and no hardcoded colors. All existing editor, registration, and theme patterns are preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Add Lovelace resource auto-registration to __init__.py</name>
  <files>template/custom_components/[[ project_domain ]]/__init__.py.jinja</files>
  <action>
Enhance `async_setup()` in `__init__.py.jinja` to auto-register the card JS as a Lovelace dashboard resource for storage-mode dashboards. This ensures the card appears in dashboards without users manually adding the resource URL.

**Add after the existing static path registration block in async_setup():**

```python
    # Auto-register as Lovelace resource (storage mode only)
    try:
        lovelace = hass.data.get("lovelace")
        if lovelace and getattr(lovelace, "mode", None) == "storage":
            if lovelace.resources.loaded:
                await _async_register_lovelace_resource(lovelace)
            else:
                async def _on_lovelace_loaded(_event=None):
                    await _async_register_lovelace_resource(lovelace)
                hass.bus.async_listen_once("lovelace_updated", _on_lovelace_loaded)
    except Exception:  # noqa: BLE001
        _LOGGER.debug("Could not auto-register Lovelace resource; add manually")
```

**Add a module-level helper function before async_setup():**

```python
async def _async_register_lovelace_resource(lovelace) -> None:
    """Register the card JS as a Lovelace resource if not already present."""
    url = FRONTEND_SCRIPT_URL
    existing = [
        r for r in lovelace.resources.async_items() if url in r.get("url", "")
    ]
    if not existing:
        await lovelace.resources.async_create_item(
            {"res_type": "module", "url": url}
        )
```

**Key design decisions:**
- Wrap in try/except because this is a community API pattern (MEDIUM confidence from research). If HA changes the internal lovelace.resources API, the integration still loads fine -- user just adds the resource manually.
- Use `_LOGGER.debug` (not warning) because this is non-critical and should not alarm users.
- Check `lovelace.resources.loaded` before accessing items -- if resources haven't loaded yet, listen for the `lovelace_updated` event.
- The `noqa: BLE001` suppresses the ruff broad-exception-caught rule -- this is intentionally broad because ANY failure in the community API should be silently handled.

**Do NOT change** any other part of __init__.py (async_setup_entry, async_unload_entry, dataclass, type alias, imports).
  </action>
  <verify>
Read the modified file and verify:
1. `_async_register_lovelace_resource` function exists
2. `lovelace` data is accessed via `hass.data.get("lovelace")`
3. Storage mode check: `getattr(lovelace, "mode", None) == "storage"`
4. Wrapped in try/except with debug log fallback
5. Existing async_setup_entry and async_unload_entry are unchanged
6. All `[[ ... ]]` Copier template variables are preserved
7. File is valid Python syntax (ignoring Copier placeholders)
  </verify>
  <done>__init__.py.jinja auto-registers the card JS as a Lovelace resource for storage-mode dashboards, with a defensive try/except fallback to manual registration.</done>
</task>

<task type="auto">
  <name>Task 3: Copier smoke test and git tag advancement</name>
  <files>template/custom_components/[[ project_domain ]]/frontend/[[ project_domain ]]-card.js.jinja, template/custom_components/[[ project_domain ]]/__init__.py.jinja</files>
  <action>
Run a copier copy to verify the card template renders correctly, then advance the git tag.

**Step 1: Copier smoke test**

Run copier copy to a temp directory with default answers:
```bash
cd /home/dab/Projects/ha-hacs-template
TMPDIR=$(mktemp -d)
source .venv/bin/activate
copier copy --defaults --trust . "$TMPDIR"
```

**Step 2: Verify rendered card JS**

Check the generated card JS file at `$TMPDIR/custom_components/hacs_template/frontend/hacs_template-card.js`:
1. File exists and is non-empty
2. No `[[ ]]` or `[% %]` Jinja artifacts remain (grep for `\[\[` and `\[%`)
3. Contains `ha-spinner` (loading state rendered)
4. Contains `ha-alert` (error state rendered)
5. Contains `getGridOptions` (sections view support rendered)
6. Contains `getStubConfig(hass)` (smart stub config rendered)
7. Contains `customElements.get(` (duplicate guard rendered)
8. Contains `window.customCards.push` (card registration rendered)
9. All `${}` JavaScript template literals are intact (not eaten by Copier)
10. Class names are PascalCase (e.g., `HacsTemplateCard`)

**Step 3: Verify rendered __init__.py**

Check `$TMPDIR/custom_components/hacs_template/__init__.py`:
1. Contains `_async_register_lovelace_resource`
2. Contains `hass.data.get("lovelace")`
3. Valid Python: run `python3 -c "import ast; ast.parse(open('$TMPDIR/custom_components/hacs_template/__init__.py').read())"` (must not raise)

**Step 4: Advance git tag**

Per decision from Phase 03-03: after adding new .jinja template files or modifying them significantly, advance the git tag so copier update works:
```bash
git tag -f 0.1.0 HEAD
```

**Step 5: Clean up temp directory**
```bash
rm -rf "$TMPDIR"
```
  </action>
  <verify>
All copier smoke test checks pass:
1. Card JS file renders without Jinja artifacts
2. Loading/error states, getGridOptions, getStubConfig(hass), duplicate guard all present in rendered output
3. __init__.py renders as valid Python with lovelace resource registration
4. Git tag 0.1.0 points to HEAD
  </verify>
  <done>Copier renders the card template correctly with all enhancements visible in the output. Git tag 0.1.0 advanced to include Phase 4 changes.</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. Card JS template contains all five CARD-07 states: loading (ha-spinner), error (ha-alert), no entity, normal render
2. Card editor pattern (CARD-02) preserved: getConfigElement, config-changed with bubbles+composed
3. Card picker registration (CARD-03) preserved: window.customCards with type, name, description, preview
4. getStubConfig(hass) finds real sensor entity (CARD-04)
5. getCardSize() returns 3, getGridOptions() returns 12-column grid sizing (CARD-05)
6. No hardcoded hex/rgb colors in styles -- only var(--...) references (CARD-06)
7. ha-card wrapper on all render paths (CARD-08)
8. Duplicate element guards on both customElements.define calls (CARD-01)
9. Lovelace resource auto-registration in __init__.py with try/except safety
10. Copier smoke test passes: rendered JS has no Jinja artifacts, rendered Python is valid
</verification>

<success_criteria>
- Card template handles loading, error, empty, and normal states
- Card appears in picker, has editor, uses theme colors, returns sizing
- customElements.define guarded against duplicate registration
- Lovelace resource auto-registered for storage-mode dashboards
- Copier renders both files correctly (no Jinja artifacts, valid syntax)
- Git tag 0.1.0 at HEAD for copier update compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-card/04-01-SUMMARY.md`
</output>
